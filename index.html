<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>SMPN 58 PLG - Sistem Manajemen Sekolah</title>
    <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/ico.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
 /* GANTI SEMUA CSS LAMA DENGAN INI */
@import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&display=swap');

:root {
    --neon-cyan: #00ffff;
    --neon-purple: #9f00ff;
    --bg-dark: #0a0a0f;
    --component-bg: rgba(28, 23, 41, 0.6); /* Sedikit keunguan & transparan */
}

* {
    font-family: 'Orbitron', sans-serif; /* Font yang lebih futuristik */
}


body {
    background-color: var(--bg-dark);
    color: var(--neon-cyan);
    text-shadow: 0 0 2px var(--neon-cyan);
    min-height: 100vh;
    background-image: radial-gradient(circle, rgba(159, 0, 255, 0.1) 0%, rgba(10, 10, 15, 0) 60%);
}

/* Efek Glow untuk Teks Utama */
.text-glow {
    color: #f5f5f5;
    text-shadow:
        0 0 5px var(--neon-cyan),
        0 0 10px var(--neon-cyan),
        0 0 20px var(--neon-purple),
        0 0 40px var(--neon-purple);
}

/* efek glow merah */
.text-glow-red {
  color: #ff5555; /* Warna merah terang */
  font-weight: bold;
  text-shadow:
    0 0 5px #ff0000,
    0 0 10px #ff0000,
    0 0 15px #ff4444;
}

/* agar teks li bisakebawah */
.word-break-li {
  overflow-wrap: break-word;
}

/* Styling untuk Container/Canvas Transparan */
.neon-canvas {
    background: var(--component-bg);
    border: 1px solid var(--neon-cyan);
    border-radius: 1rem;
    box-shadow: 0 0 10px var(--neon-cyan), inset 0 0 10px var(--neon-cyan);
    backdrop-filter: blur(10px);
    transition: all 0.3s ease;
}

.neon-canvas:hover {
    box-shadow: 0 0 20px var(--neon-purple), inset 0 0 20px var(--neon-purple);
    border-color: var(--neon-purple);
}


/* Input Form Neon */
.neon-input {
    background: rgba(0,0,0,0.3);
    border: 1px solid var(--neon-cyan);
    color: #fff;
    border-radius: 8px;
    transition: all 0.3s ease;
}
.neon-input:focus {
    outline: none;
    border-color: var(--neon-purple);
    box-shadow: 0 0 15px var(--neon-purple);
}

/* ============================================= */
/* ==      STYLE UNTUK SEMUA DROPDOWN         == */
/* ============================================= */
/* GANTI KODE CSS DROPDOWN LAMA ANDA DENGAN VERSI INI */

select.neon-input {
    -webkit-appearance: none !important;
    -moz-appearance: none !important;
    appearance: none !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
    background-position: right 0.5rem center !important;
    background-repeat: no-repeat !important;
    background-size: 1.5em 1.5em !important;
    padding-right: 2.5rem !important; /* Beri ruang untuk ikon panah */
}

/* Atur warna panah saat dropdown difokuskan */
select.neon-input:focus {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238B5CF6' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e") !important;
}

/* Notifikasi Pop-up Baru */
.notification-container {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1000;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
}

.notification-container.show {
    opacity: 1;
    visibility: visible;
}

.notification-popup {
    padding: 2rem;
    text-align: center;
    transform: scale(0);
    opacity: 0;
}

.notification-container.show .notification-popup {
    animation: neonBounceIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
}

.notification-popup.hide {
    animation: neonFadeOut 0.4s ease-out forwards;
}

.notification-popup i {
    font-size: 3rem;
    margin-bottom: 1rem;
    display: block;
}

.notification-popup.success i {
    color: #00ff00;
    text-shadow: 0 0 10px #00ff00;
}
.notification-popup.error i {
    color: #ff0000;
    text-shadow: 0 0 10px #ff0000;
}

#notificationText {
    font-size: 1.25rem;
    font-weight: bold;
}

/* Animasi untuk Notifikasi */
@keyframes neonBounceIn {
    0% { transform: scale(0.3); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes neonFadeOut {
    from { transform: scale(1); opacity: 1; }
    to { transform: scale(0.5); opacity: 0; }
}

/* TAMBAHKAN BLOK CSS INI */
.neon-input.status-hadir {
    border-color: #00ff00; /* Hijau Neon */
    box-shadow: 0 0 15px #00ff00;
}
.neon-input.status-sakit {
    border-color: #ffff00; /* Kuning Neon */
    box-shadow: 0 0 15px #ffff00;
}
.neon-input.status-izin {
    border-color: #00aaff; /* Biru Neon */
    box-shadow: 0 0 15px #00aaff;
}
.neon-input.status-alfa {
    border-color: #ff0055; /* Merah Muda/Magenta Neon */
    box-shadow: 0 0 15px #ff0055;
}

/* Loading Spinner */
.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--neon-cyan);
    animation: spin 1s ease-in-out infinite;
}

    /* Custom Neon Glow for Spinners */
    .neon-border {
        border-top-color: #0ff; /* Cyan */
        border-bottom-color: #f0f; /* Magenta */
        box-shadow: 0 0 5px #0ff, 0 0 10px #0ff, 0 0 15px #0ff,
                    0 0 5px #f0f, 0 0 10px #f0f, 0 0 15px #f0f;
    }
    .neon-border-inner {
        border-top-color: #fff; /* White */
        border-left-color: #0ff; /* Cyan */
        box-shadow: 0 0 3px #fff, 0 0 6px #fff, 0 0 9px #fff;
    }

    /* Keyframe untuk putaran berlawanan arah jarum jam */
    @keyframes spin-reverse {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(-360deg);
        }
    }
    .animate-spin-reverse {
        animation: spin-reverse 1.5s linear infinite;
    }

/* ============================================= */
/* == GAYA FINAL TOMBOL NEON (GARIS BERSINAR) == */
/* ============================================= */

/* 1. Aturan Dasar untuk SEMUA tombol */
.btn-primary, .btn-secondary, .btn-danger, .btn-neon-green {
    padding: 0.75rem 1.5rem;
    border-radius: 9999px;
    font-weight: 600;
    transition: all 0.3s ease;
    border: 2px solid;
    background-color: transparent; /* UBAH JADI TRANSPARAN */
    text-shadow: none;
    position: relative;
    overflow: hidden;
}

/* Mengatur posisi teks & spinner */
.btn-text, .btn-loading {
    display: flex;
    align-items: center;
    justify-content: center;
    transition: opacity 0.3s ease;
}

/* 2. Aturan Warna & Hover untuk setiap jenis tombol */

/* GANTI BLOK CSS UNTUK .btn-primary ANDA DENGAN INI */

/* Primary (Cyan, dengan hover Ungu Neon) */
.btn-primary {
    border-color: #00ffff; /* Warna garis awal menjadi Cyan */
    color: #e0ffff;       /* Warna teks menjadi Cyan pucat */
    box-shadow: 0 0 8px #00ffff, inset 0 0 8px rgba(0, 255, 255, 0.3); /* Glow awal Cyan + glow dalam */
}
.btn-primary:hover {
    border-color: #9f00ff; /* Warna garis hover menjadi Ungu Neon */
    box-shadow: 0 0 15px #9f00ff, 0 0 25px #9f00ff, inset 0 0 10px rgba(159, 0, 255, 0.5); /* Glow hover Ungu + glow dalam */
    color: #f5f5f5;       /* Warna teks menjadi putih terang */
}

/* Secondary (Abu-abu/Netral) */
.btn-secondary {
    border-color: #6b7280;
    color: #e5e7eb;
}
.btn-secondary:hover {
    border-color: #9ca3af;
    box-shadow: 0 0 15px #9ca3af;
    color: #fff;
}

/* Danger (Merah) */
.btn-danger {
    border-color: #ef4444;
    color: #fecaca;
}
.btn-danger:hover {
    border-color: #f87171;
    box-shadow: 0 0 15px #f87171;
    color: #fff;
}

/* Green (untuk "Hadir Semua") */
.btn-neon-green {
    border-color: #00ff00;
    color: #e6fffa;
}
.btn-neon-green:hover {
    border-color: #66ff66;
    box-shadow: 0 0 20px #00ff00;
    color: #fff;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.sidebar-transition {
    transition: transform 0.3s ease-in-out;
}
    
    /* ===== TAMBAHKAN CSS BARU INI ===== */
    .signature-container {
        margin-top: 50px;
        display: flex;
        justify-content: space-between;
    }
    .signature-block {
        width: 40%;
        text-align: center;
    }
    .signature-block .name {
        font-weight: bold;
        text-decoration: underline;
    }

    #notificationContainer {
    z-index: 2000;
    }

/* CSS untuk Tooltip Ikon */
.icon-button {
    position: relative;
    display: inline-block;
}

.icon-button .tooltip-text {
    visibility: hidden;
    width: 80px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 5px 0;
    position: absolute;
    z-index: 1;
    bottom: 125%; /* Posisikan di atas tombol */
    left: 50%;
    margin-left: -40px; /* Pusatkan tooltip */
    opacity: 0;
    transition: opacity 0.3s;
}

.icon-button:hover .tooltip-text {
    visibility: visible;
    opacity: 1;
}
/* ============================================= */
/* ==   EFEK CAHAYA PADA IKON (BARU)          == */
/* ============================================= */

/* Aturan dasar transisi untuk semua ikon di dalam tombol */
.btn-secondary i, .btn-danger i {
    transition: all 0.3s ease;
}

/* Efek cahaya putih saat tombol secondary (Edit) disentuh */
.btn-secondary:hover i {
    text-shadow: 0 0 8px #ffffff, 0 0 10px #ffffff;
}

/* Efek cahaya MERAH saat tombol danger (Hapus) disentuh */
.btn-danger:hover i {
    text-shadow: 0 0 8px #ef4444, 0 0 10px #ef4444;
}
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen">
    <!-- Spinner -->
    <div id="loadingOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="w-24 h-24 border-8 border-cyan-400 border-solid rounded-full animate-spin border-t-transparent"></div>
    </div>
    <!-- Notification -->
<div id="notificationContainer" class="notification-container">
    <div id="notificationPopup" class="notification-popup neon-canvas">
        <i id="notificationIcon" class="fas"></i>
        <span id="notificationText"></span>
    </div>
</div>

    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-purple-900 to-violet-900">
        <div class="neon-canvas p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <i class="fas fa-user-astronaut text-5xl mb-4 text-glow"></i> 
                <h1 class="text-3xl font-bold text-white mb-2">SMPN 58 PLG</h1>
                <p class="text-gray-400">Sistem Manajemen Sekolah</p>
            </div>
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Username</label>
                    <input type="text" id="username" class="w-full px-4 py-3 neon-canvas transition-all duration-300" placeholder="Masukkan username">
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Password</label>
                    <input type="password" id="password" class="w-full px-4 py-3 neon-canvas transition-all duration-300" placeholder="Masukkan password">
                </div>
                <button type="submit" class="w-full btn-primary text-white py-3 rounded-lg font-semibold">
                    <i class="fas fa-sign-in-alt mr-2"></i>Masuk
                </button>
                <div class="text-center text-sm text-gray-400 mt-4">
                <a href="#" onclick="showForgotPasswordPage()" class="text-cyan-400 hover:text-cyan-300">Lupa Password?</a>
                </div>
                <p class="text-center text-sm text-glow mt-6">
                    Belum punya akun? 
                    <a href="#" onclick="showRegisterPage()" class="font-semibold text-cyan-400 hover:text-cyan-300">
                    Daftar di sini
                </a>
                </p>
            </form>
    <p class="text-center text-xs text-glow mt-8">
        © 2025 Aris Bermansyah, S.Kom
    </p>
        </div>
    </div>


<!---- REGISTER PAGE ---->
<div id="registerPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-purple-900 to-violet-900 hidden">
    <div class="neon-canvas p-6 w-full max-w-md"> 
        <div class="text-center mb-6"> <i class="fas fa-user-plus text-4xl mb-4 text-glow"></i> <h1 class="text-2xl font-bold text-white mb-2">Pendaftaran Akun Guru</h1> </div>
        <form id="registerForm" class="space-y-3">
            <div>
                <label class="block text-sm font-medium text-glow mb-1">Username</label>
                <input type="text" id="regUsername" class="w-full neon-input p-3" placeholder="Username untuk login" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-1">Password</label>
                <input type="password" id="regPassword" class="w-full neon-input p-3" placeholder="Password" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-1">Alamat Email</label>
                <input type="email" id="regEmail" class="w-full neon-input p-3" placeholder="Email aktif untuk pemulihan akun" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-1">Nama Lengkap & Gelar</label>
                <input type="text" id="regNamaLengkap" class="w-full neon-input p-3" placeholder="Contoh: Aris Bermansyah, S.Kom" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-1">NIP / NIPPPK (jika ada)</label>
                <input type="text" id="regNip" class="w-full neon-input p-3" placeholder="Contoh: NIP. 19961114202211....">
            </div>
            <button type="submit" class="w-full btn-primary py-3 rounded-lg font-semibold !mt-6"> <span class="btn-text">Kirim Permintaan Pendaftaran</span>
                <span class="btn-loading hidden">...</span>
            </button>
        </form>
        <p class="text-center text-sm text-glow mt-4"> Sudah punya akun? 
            <a href="#" onclick="showLoginPage()" class="font-semibold text-cyan-400 hover:text-cyan-300">
                Kembali ke Login
            </a>
        </p>
    </div>
</div>

<!-- LUPA PASSWORD -->
<div id="forgotPasswordPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-purple-900 to-violet-900 hidden">
    <div class="neon-canvas p-8 w-full max-w-md">
        <div class="text-center mb-8">
            <i class="fas fa-question-circle text-5xl mb-4 text-glow"></i>
            <h1 class="text-3xl font-bold text-white mb-2">Lupa Password</h1>
            <p class="text-gray-400">Masukkan username Anda untuk meminta reset password.</p>
        </div>
        <form id="forgotPasswordForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-glow mb-2">Username</label>
                <input type="text" id="forgotUsername" class="w-full neon-input p-3" placeholder="Username akun Anda" required>
            </div>
            <button type="submit" class="w-full btn-primary py-3 rounded-lg font-semibold mt-4">
                <span class="btn-text">Kirim Permintaan</span>
                <span class="btn-loading hidden"><div class="loading mr-2"></div>Mengirim...</span>
            </button>
        </form>
        <p class="text-center text-sm text-glow mt-6">
            <a href="#" onclick="showLoginPage()" class="font-semibold text-cyan-400 hover:text-cyan-300">
                Kembali ke Login
            </a>
        </p>
    </div>
</div>


<!-- PAGE UNTUK PERJELAS LUPA PASSWORD -->
<div id="forgotPasswordSuccessPage" class="min-h-screen flex items-center justify-center bg-gradient-to-br from-gray-900 via-purple-900 to-violet-900 hidden">
    <div class="neon-canvas p-6 sm:p-8 w-11/12 md:w-full md:max-w-lg text-center">
        <div class="text-green-400 text-6xl mb-4">
            <i class="fas fa-check-circle"></i>
        </div>
        <h1 class="text-2xl font-bold text-white mb-4">Permintaan Terkirim!</h1>
        <div class="text-gray-300 text-left space-y-3 text-sm">
            <p>Kami telah mengirimkan password sementara ke alamat email yang terdaftar untuk akun Anda.</p>
            <ul class="list-disc list-inside bg-gray-900/50 p-4 rounded-lg">
            <li>Buka aplikasi email Anda.</li>
            <li>Jika email tidak ada di kotak masuk utama, <span class="text-glow-red">(periksa pada folder SPAM).</span></li>
            <li class="word-break-li">Cari email dari pengirim: <strong id="adminEmailDisplay" class="text-glow"></strong></li>
            </ul>
            <p>Gunakan password sementara tersebut untuk login dan segera ganti password defaultnya pada menu profile.</p>
        </div>
        <button onclick="showLoginPage()" class="w-full btn-primary py-3 rounded-lg font-semibold mt-8">
            Kembali ke Halaman Login
        </button>
    </div>
</div>


    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
<header class="sticky top-0 z-40 neon-canvas rounded-none border-x-0 border-t-0 border-b-2">
    <div class="flex items-center justify-between px-6 py-4">
        <div class="flex items-center space-x-4">
            <button id="sidebarToggle" class="text-glow hover:text-white transition-colors duration-200 p-2 rounded-lg hover:neon-input">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 id="pageTitle" class="text-xl font-semibold text-glow">Beranda</h1>
        </div>
        <div class="flex items-center space-x-4">
            <span id="userNameDisplay" class="hidden sm:inline text-xl font-semibold text-glow mr-2"></span> 
            <i class="fas fa-graduation-cap text-2xl text-glow"></i>
        </div>
    </div>
</header>

        <!-- Sidebar -->
        <aside id="sidebar" class="fixed left-0 top-0 h-full w-64 neon-canvas rounded-none border-y-0 border-l-0 border-r-2 shadow-lg z-50 sidebar-transition transform -translate-x-full">
            <!-- Sidebar Header with Close Button -->
            <div class="p-6 border-b border-gray-700 border-opacity-50">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-graduation-cap text-3xl text-glow"></i>
                        <div>
                            <h2 class="text-sm font-bold text-glow">SMPN 58 PLG</h2>
                            <p class="text-sm text-glow">Admin Panel</p>
                        </div>
                    </div>
                    <!-- Close button for all devices -->
                    <button id="sidebarClose" class="text-gray-400 hover:text-white transition-colors duration-200 p-2 rounded-lg hover:neon-input">
                        <i class="fas fa-times text-glow"></i>
                    </button>
                </div>
            </div>
            
            <nav class="mt-6">
                <a href="#" onclick="showPage('beranda')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-home mr-3 text-glow"></i>Beranda
                </a>
                <a href="#" onclick="showPage('agenda-guru')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-calendar-alt mr-3 text-glow"></i>Agenda Guru
                </a>
                <a href="#" onclick="showPage('jurnal-guru')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-book mr-3 text-glow"></i>Jurnal Guru
                </a>
                <a href="#" onclick="showPage('absensi')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-user-check mr-3 text-glow"></i>Absensi
                </a>
                <a href="#" onclick="showPage('siswa')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-users mr-3 text-glow"></i>Data Siswa
                </a>
                <a href="#" onclick="showPage('penilaian')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-star mr-3 text-glow"></i>Penilaian
                </a>
                <a href="#" onclick="showPage('rekapan')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-chart-bar mr-3 text-glow"></i>Rekapan
                </a>
                <a href="#" onclick="aksesMenuMGMP()" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-gray-700 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-chalkboard-teacher mr-3 text-glow"></i>MGMP
                </a>
                <a href="#" onclick="showPage('profil')" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-purple-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-user-circle mr-3 text-glow"></i>Profil Saya
                </a>
                <a href="#" onclick="logout()" class="nav-item flex items-center px-6 py-3 text-glow hover:bg-red-600 hover:bg-opacity-30 hover:text-white transition-all duration-200">
                    <i class="fas fa-sign-out-alt mr-3 text-glow"></i>Logout
                </a>
            </nav>
            
            <div class="absolute bottom-4 left-0 right-0 px-6">
                <p class="text-xs text-gray-500 text-center">© 2025 Aris Bermansyah, S.Kom</p>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="mainContent" class="min-h-screen bg-gray-900">
            <!-- Beranda -->
            <div id="berandaPage" class="page-content p-6">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Selamat Datang</h2>
                    <p class="text-gray-400">Sistem Manajemen Sekolah SMPN 58 Palembang</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div onclick="showPage('agenda-guru')" class="neon-canvas p-6 cursor-pointer">
                    <i class="fas fa-calendar-alt text-4xl mb-4 text-glow"></i>
                    <h3 class="text-xl font-semibold mb-2 text-glow">Agenda Guru</h3>
                    <p style="color:var(--neon-cyan)">Kelola agenda dan jadwal mengajar</p>
                    </div>
                    
                    <div onclick="showPage('jurnal-guru')" class="neon-canvas p-6 cursor-pointer">
                        <i class="fas fa-book text-4xl text-glow mb-4"></i>
                        <h3 class="text-xl font-semibold text-glow mb-2">Jurnal Guru</h3>
                        <p style="color:var(--neon-cyan)">Catat kegiatan pembelajaran harian</p>
                    </div>
                    
                    <div onclick="showPage('siswa')" class="neon-canvas p-6 cursor-pointer">
                        <i class="fas fa-users text-4xl text-glow mb-4"></i>
                        <h3 class="text-xl font-semibold text-glow mb-2">Data Siswa</h3>
                        <p style="color:var(--neon-cyan)">Kelola data siswa per kelas</p>
                    </div>
                    
                    <div onclick="showPage('absensi')" class="neon-canvas p-6 cursor-pointer">
                        <i class="fas fa-user-check text-4xl text-glow mb-4"></i>
                        <h3 class="text-xl font-semibold text-glow mb-2">Absensi</h3>
                        <p style="color:var(--neon-cyan)">Kelola kehadiran siswa</p>
                    </div>
                    
                    <div onclick="showPage('penilaian')" class="neon-canvas p-6 cursor-pointer">
                        <i class="fas fa-star text-4xl text-glow mb-4"></i>
                        <h3 class="text-xl font-semibold text-glow mb-2">Penilaian</h3>
                        <p style="color:var(--neon-cyan)">Input dan kelola nilai siswa</p>
                    </div>
                    
                    <div onclick="showPage('rekapan')" class="neon-canvas p-6 cursor-pointer">
                        <i class="fas fa-chart-bar text-4xl text-glow mb-4"></i>
                        <h3 class="text-xl font-semibold text-glow mb-2">Rekapan</h3>
                        <p style="color:var(--neon-cyan)">Lihat laporan dan statistik</p>
                    </div>

                    <div onclick="aksesMenuMGMP()" class="neon-canvas p-6 cursor-pointer">
                        <i class="fas fa-chalkboard-teacher text-4xl text-glow mb-4"></i>
                        <h3 class="text-xl font-semibold text-glow mb-2">MGMP</h3>
                        <p style="color:var(--neon-cyan)">Agenda & Notulen Rapat MGMP</p>
                    </div>
                </div>
            </div>

            <!-- Agenda Guru -->
            <div id="agendaGuruPage" class="page-content p-6 hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Agenda Guru</h2>
                    <p class="text-gray-400">Kelola agenda dan jadwal mengajar</p>
                </div>
                
                <div class="neon-canvas p-6 mb-8">
                    <h3 class="text-xl font-semibold text-glow mb-6">Tambah Agenda Baru</h3>
                    <form id="agendaForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="hidden" id="agendaTimestamp">
                        <div class="md:col-span-2 flex items-center space-x-4">
    <button type="button" onclick="openMapelModal()" class="btn-primary px-6 py-3 text-glow rounded-lg font-semibold">
        <i class="fas fa-cog mr-2"></i>Kelola Mapel
    </button>
</div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Tanggal</label>
                            <input type="date" id="agendaTanggal" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Waktu</label>
                            <input type="time" id="agendaWaktu" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Mata Pelajaran</label>
                            <select id="agendaMapel" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                            <select id="agendaKelas" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="7.1">7.1</option>
                                <option value="7.2">7.2</option>
                                <option value="7.3">7.3</option>
                                <option value="7.4">7.4</option>
                                <option value="8.1">8.1</option>
                                <option value="8.2">8.2</option>
                                <option value="8.3">8.3</option>
                                <option value="8.4">8.4</option>
                                <option value="9.1">9.1</option>
                                <option value="9.2">9.2</option>
                                <option value="9.3">9.3</option>
                                <option value="9.4">9.4</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-glow mb-2">Materi/Kegiatan</label>
                            <textarea id="agendaMateri" rows="3" class="w-full px-4 py-3 neon-input text-sm sm:text-base" placeholder="Deskripsi materi atau kegiatan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Jenis Kegiatan</label>
                            <select id="agendaJenis" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="Pembelajaran">Pembelajaran</option>
                                <option value="Ulangan">Ulangan</option>
                                <option value="Praktikum">Praktikum</option>
                                <option value="Diskusi">Diskusi</option>
                                <option value="Presentasi">Presentasi</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold">
                                <span class="btn-text"><i class="fas fa-plus mr-2"></i>Tambah Agenda</span>
                                <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                            </button>
                        </div>
                    </form>
                </div>
                
<div class="neon-canvas p-6">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0 mb-6">
        <h3 class="text-xl font-semibold text-white">Daftar Agenda</h3>
        <div class="flex items-center space-x-4">
            <select id="filterMapelAgenda" onchange="displayAgendaList()" class="px-4 py-2 neon-input w-full sm:w-auto">
                </select>
            
            <button onclick="printData('agenda')" class="btn-primary px-4 py-2 rounded-lg text-glow text-sm w-full sm:w-auto">
                <i class="fas fa-print mr-2"></i>Cetak
            </button>
        </div>
    </div>
    
    <div id="agendaList" class="space-y-4">
        </div>
</div>
</div>

            <!-- Jurnal Guru -->
            <div id="jurnalGuruPage" class="page-content p-6 hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Jurnal Guru</h2>
                    <p class="text-gray-400">Catat kegiatan pembelajaran harian</p>
                </div>
                
                <div class="neon-canvas p-6 mb-8">
                    <h3 class="text-xl font-semibold text-white mb-6">Tambah Jurnal Baru</h3>
                    <form id="jurnalForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="md:col-span-2 flex items-center space-x-4">
    <button type="button" onclick="openMapelModal()" class="btn-primary px-6 py-3 text-glow rounded-lg font-semibold">
        <i class="fas fa-cog mr-2"></i>Kelola Mapel
    </button>
</div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Tanggal</label>
                            <input type="date" id="jurnalTanggal" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Jam Ke</label>
                            <select id="jurnalJam" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="1">1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                                <option value="6">6</option>
                                <option value="7">7</option>
                                <option value="8">8</option>
                                <option value="9">9</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Mata Pelajaran</label>
                            <select id="jurnalMapel" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                            <select id="jurnalKelas" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="7.1">7.1</option>
                                <option value="7.2">7.2</option>
                                <option value="7.3">7.3</option>
                                <option value="7.4">7.4</option>
                                <option value="8.1">8.1</option>
                                <option value="8.2">8.2</option>
                                <option value="8.3">8.3</option>
                                <option value="8.4">8.4</option>
                                <option value="9.1">9.1</option>
                                <option value="9.2">9.2</option>
                                <option value="9.3">9.3</option>
                                <option value="9.4">9.4</option>
                            </select>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-glow mb-2">Materi yang Diajarkan</label>
                            <textarea id="jurnalMateri" rows="3" class="w-full px-4 py-3 neon-input text-sm sm:text-base" placeholder="Deskripsi materi yang diajarkan"></textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Jumlah Siswa Hadir</label>
                            <input type="number" id="jurnalHadir" min="0" max="40" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Jumlah Siswa Tidak Hadir</label>
                            <input type="number" id="jurnalTidakHadir" min="0" max="40" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-glow mb-2">Catatan/Kendala (Opsional)</label>
                            <textarea id="jurnalCatatan" rows="3" class="w-full px-4 py-3 neon-input text-sm sm:text-base" placeholder="Catatan atau kendala yang dihadapi"></textarea>
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="btn-primary px-6 py-3 rounded-lg text-glow font-semibold">
                                <span class="btn-text"><i class="fas fa-plus mr-2"></i>Tambah Jurnal</span>
                                <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                            </button>
                        </div>
                    </form>
                </div>
                
            <div class="neon-canvas p-6">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0 mb-6">
        <h3 class="text-xl font-semibold text-white">Daftar Jurnal</h3>
        <div class="flex items-center space-x-4">
            <select id="filterMapelJurnal" onchange="displayJurnalList()" class="px-4 py-2 neon-input w-full sm:w-auto">
                </select>
            
            <button onclick="printData('jurnal')" class="btn-primary px-4 py-2 rounded-lg text-glow text-sm w-full sm:w-auto">
                <i class="fas fa-print mr-2"></i>Cetak
            </button>
        </div>
    </div>
    
    <div id="jurnalList" class="space-y-4">
        </div>
</div>
</div>

            <!-- Data Siswa -->
            <div id="siswaPage" class="page-content p-6 hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Data Siswa</h2>
                    <p class="text-gray-400">Kelola data siswa per kelas</p>
                </div>
                
                <div class="neon-canvas p-6 mb-8">
                    <h3 class="text-xl font-semibold text-white mb-6">Tambah Siswa Baru</h3>
                    <form id="siswaForm" class="grid grid-cols-1 md:grid-cols-3 gap-4 sm:gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-glow mb-2">Nama Lengkap</label>
                            <input type="text" id="namaSiswa" class="w-full px-4 py-3 neon-input text-sm sm:text-base" placeholder="Nama lengkap siswa">
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                            <select id="kelasSiswa" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="7.1">7.1</option>
                                <option value="7.2">7.2</option>
                                <option value="7.3">7.3</option>
                                <option value="7.4">7.4</option>
                                <option value="8.1">8.1</option>
                                <option value="8.2">8.2</option>
                                <option value="8.3">8.3</option>
                                <option value="8.4">8.4</option>
                                <option value="9.1">9.1</option>
                                <option value="9.2">9.2</option>
                                <option value="9.3">9.3</option>
                                <option value="9.4">9.4</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <button type="submit" class="btn-primary px-4 sm:px-6 py-3 rounded-lg text-white font-semibold mt-6 w-full sm:w-auto text-sm sm:text-base">
                                <span class="btn-text"><i class="fas fa-plus mr-2"></i>Tambah Siswa</span>
                                <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="neon-canvas p-4 sm:p-6 mb-8">
                    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 space-y-4 sm:space-y-0">
                        <h3 class="text-lg sm:text-xl font-semibold text-white">Filter Data Siswa</h3>
                        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4">
                            <select id="filterKelas" class="px-4 py-2 neon-input border border-gray-600 rounded-lg text-white text-sm sm:text-base min-w-0 sm:min-w-32">
                                <option value="">Semua Kelas</option>
                                <option value="7.1">7.1</option>
                                <option value="7.2">7.2</option>
                                <option value="7.3">7.3</option>
                                <option value="7.4">7.4</option>
                                <option value="8.1">8.1</option>
                                <option value="8.2">8.2</option>
                                <option value="8.3">8.3</option>
                                <option value="8.4">8.4</option>
                                <option value="9.1">9.1</option>
                                <option value="9.2">9.2</option>
                                <option value="9.3">9.3</option>
                                <option value="9.4">9.4</option>
                            </select>
                            <button onclick="loadDataSiswa()" class="btn-primary px-4 py-2 rounded-lg text-white text-sm sm:text-base whitespace-nowrap">
                                <i class="fas fa-search mr-2"></i>Filter
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="neon-canvas p-6">
                    <h3 class="text-xl font-semibold text-white mb-6">Daftar Siswa</h3>
                    <div id="siswaList" class="overflow-x-auto">
                        <table class="w-full text-left min-w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-4 pr-6 text-glow text-sm sm:text-base" style="width: 60px;">No</th>
                                    <th class="pb-4 pr-6 text-glow text-sm sm:text-base w-full" style="min-width: 200px;">Nama Siswa</th>
                                    <th class="pb-4 pr-6 text-glow text-sm sm:text-base" style="width: 100px;">Kelas</th>
                                    <th class="pb-4 text-glow text-sm sm:text-base" style="width: 80px;">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="siswaTableBody">
                                <!-- Student data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Absensi -->
            <div id="absensiPage" class="page-content p-6 hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Absensi Siswa</h2>
                    <p class="text-gray-400">Kelola kehadiran siswa</p>
                </div>
                
                <div class="neon-canvas p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Jenis Absen</label>
                            <select id="jenisAbsen" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="Wali Kelas">Wali Kelas</option>
                                <option value="Guru Mapel">Guru Mapel</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                            <select id="kelasAbsen" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="7.1">7.1</option>
                                <option value="7.2">7.2</option>
                                <option value="7.3">7.3</option>
                                <option value="7.4">7.4</option>
                                <option value="8.1">8.1</option>
                                <option value="8.2">8.2</option>
                                <option value="8.3">8.3</option>
                                <option value="8.4">8.4</option>
                                <option value="9.1">9.1</option>
                                <option value="9.2">9.2</option>
                                <option value="9.3">9.3</option>
                                <option value="9.4">9.4</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Tanggal</label>
                            <input type="date" id="tanggalAbsen" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        </div>
                    </div>
                    <button onclick="loadAbsensi()" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold mb-6">
                        <i class="fas fa-search mr-2"></i>Muat Data Siswa
                    </button>
                </div>
                
<div id="absensiContainer" class="neon-canvas p-6 hidden">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between space-y-4 sm:space-y-0 mb-6">
        <h3 class="text-xl font-semibold text-white">Daftar Siswa</h3>
        <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
            <button onclick="hadirSemua()" class="btn-neon-green px-6 py-3 rounded-lg font-semibold">
            <i class="fas fa-check-double mr-2"></i>Hadir Semua
            </button>
            <button onclick="simpanAbsensi()" class="btn-primary px-6 py-3 rounded-lg text-glow font-semibold">
                <span class="btn-text"><i class="fas fa-save mr-2"></i>Simpan Absensi</span>
                <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
            </button>
        </div>
    </div>

                    <div id="siswaGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Student cards will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Penilaian -->
            <div id="penilaianPage" class="page-content p-6 hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-white mb-2">Penilaian Siswa</h2>
                    <p class="text-gray-400">Input dan kelola nilai siswa</p>
                </div>
                
                <div class="neon-canvas p-6 mb-8">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                            <select id="kelasPenilaian" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="7.1">7.1</option>
                                <option value="7.2">7.2</option>
                                <option value="7.3">7.3</option>
                                <option value="7.4">7.4</option>
                                <option value="8.1">8.1</option>
                                <option value="8.2">8.2</option>
                                <option value="8.3">8.3</option>
                                <option value="8.4">8.4</option>
                                <option value="9.1">9.1</option>
                                <option value="9.2">9.2</option>
                                <option value="9.3">9.3</option>
                                <option value="9.4">9.4</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Jenis Penilaian</label>
                            <select id="jenisPenilaian" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                                <option value="Harian">Harian</option>
                                <option value="Tugas">Tugas</option>
                                <option value="Bab">Bab</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-glow mb-2">Keterangan</label>
                            <input type="text" id="keteranganPenilaian" class="w-full px-4 py-3 neon-input text-sm sm:text-base" placeholder="Contoh: Ulangan Harian Bab 1">
                        </div>
                    </div>
                    <button onclick="loadPenilaian()" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold mb-6">
                        <i class="fas fa-search mr-2"></i>Muat Data Siswa
                    </button>
                </div>
                
                <div id="penilaianContainer" class="neon-canvas p-6 hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-semibold text-white">Input Nilai</h3>
                        <button onclick="simpanPenilaian()" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold">
                            <span class="btn-text"><i class="fas fa-save mr-2"></i>Simpan Nilai</span>
                            <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left min-w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="pb-4 pr-6 text-glow text-sm sm:text-base" style="width: 60px;">No</th>
                                    <th class="pb-4 pr-6 text-glow text-sm sm:text-base" style="min-width: 200px;">Nama Siswa</th>
                                    <th class="pb-4 text-glow text-sm sm:text-base" style="width: 150px;">Nilai (0-100)</th>
                                </tr>
                            </thead>
                            <tbody id="penilaianTable">
                                <!-- Student rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div> 
    <div class="neon-canvas p-6 mt-8"> 
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-semibold text-glow">Riwayat Penilaian Anda</h3>
        <button id="cetakPenilaianBtn" class="btn-primary px-4 py-2 rounded-lg text-glow text-sm w-full sm:w-auto">
        <i class="fas fa-print mr-2"></i>Cetak
        </button>
    </div>

    <div id="daftarPenilaian" class="space-y-4">
        </div>

</div>
            </div>

<!----rekapan----->
<div id="rekapanPage" class="page-content p-6 hidden">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-white mb-2">Rekapan Data</h2>
        <p class="text-gray-400">Lihat laporan dan statistik</p>
    </div>
    
    <div class="neon-canvas p-6 mb-8">
        <div class="flex space-x-1 mb-6 border-b border-purple-500 pb-1">
            <button onclick="showRekapTab('absensi')" id="tabAbsensi" class="px-6 py-3 bg-purple-600 text-white rounded-t-lg font-semibold">Rekapan Absensi</button>
            <button onclick="showRekapTab('kehadiran')" id="tabKehadiran" class="px-6 py-3 neon-input text-glow rounded-t-lg font-semibold">Total Kehadiran</button>
        </div>
        
        <div id="rekapAbsensiTab">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                    <select id="kelasRekapAbsensi" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        <option value="7.1">7.1</option>
                        <option value="7.2">7.2</option>
                        <option value="7.3">7.3</option>
                        <option value="7.4">7.4</option>
                        <option value="8.1">8.1</option>
                        <option value="8.2">8.2</option>
                        <option value="8.3">8.3</option>
                        <option value="8.4">8.4</option>
                        <option value="9.1">9.1</option>
                        <option value="9.2">9.2</option>
                        <option value="9.3">9.3</option>
                        <option value="9.4">9.4</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Jenis Absensi</label>
                    <select id="jenisAbsensiRekap" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        <option value="Wali Kelas">Wali Kelas</option>
                        <option value="Guru Mapel">Guru Mapel</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Periode</label>
                    <select id="periodeRekap" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        <option value="harian">Harian</option>
                        <option value="bulanan">Bulanan</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Tanggal/Bulan</label>
                    <input type="date" id="tanggalRekapAbsensi" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                </div>
            </div>
            <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-4">
                <button onclick="loadRekapAbsensi()" class="btn-primary w-full md:w-auto px-6 py-3 rounded-lg text-white font-semibold">
                    <i class="fas fa-search mr-2"></i>Tampilkan Rekap
                </button>
                <button onclick="testDatabaseConnection()" class="neon-canvas w-full md:w-auto px-6 py-3 rounded-lg text-white font-semibold transition-colors duration-200">
                    <i class="fas fa-database mr-2"></i>Test Database
                </button>
                </div>
        </div>
        
        <div id="rekapKehadiranTab" class="hidden">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                    <select id="kelasKehadiran" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        <option value="7.1">7.1</option>
                        <option value="7.2">7.2</option>
                        <option value="7.3">7.3</option>
                        <option value="7.4">7.4</option>
                        <option value="8.1">8.1</option>
                        <option value="8.2">8.2</option>
                        <option value="8.3">8.3</option>
                        <option value="8.4">8.4</option>
                        <option value="9.1">9.1</option>
                        <option value="9.2">9.2</option>
                        <option value="9.3">9.3</option>
                        <option value="9.4">9.4</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Jenis Absensi</label>
                    <select id="jenisKehadiran" class="w-full px-4 py-3 neon-input text-sm sm:text-base">
                        <option value="Wali Kelas">Wali Kelas</option>
                        <option value="Guru Mapel">Guru Mapel</option>
                    </select>
                </div>
                <div>
                    <button onclick="loadTotalKehadiran()" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold w-full mt-0 md:mt-7">
                        <i class="fas fa-users mr-2"></i>Tampilkan Total Kehadiran
                    </button>
                </div>
            </div>
        </div>

        <div class="border-t border-purple-500 mt-8 pt-6">
            <button onclick="cetakRekap()" class="btn-secondary w-full sm:w-auto px-6 py-3 rounded-lg font-semibold">
                <i class="fas fa-print mr-2"></i>Cetak Laporan yang Ditampilkan
            </button>
        </div>
        </div>
    
    <div id="rekapContainer" class="neon-canvas p-6 hidden">
        <div id="rekapContent">
            </div>
    </div>
</div>

 <!----ini page mgmp------>
    <div id="mgmpPage" class="page-content p-6 hidden">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-white mb-2">MGMP (Musyawarah Guru Mata Pelajaran)</h2>
        <p class="text-gray-400">Kelola agenda dan notulen rapat MGMP</p>
    </div>
    
    <div class="flex space-x-1 mb-6 border-b border-purple-500">
        <button onclick="showMgmpTab('agenda')" id="tabMgmpAgenda" class="px-6 py-3 bg-purple-600 text-white rounded-t-lg font-semibold">Agenda MGMP</button>
        <button onclick="showMgmpTab('notulen')" id="tabMgmpNotulen" class="px-6 py-3 neon-input text-glow rounded-t-lg font-semibold">Notulen</button>
    </div>

    <div id="mgmpAgendaTab">
        <div class="neon-canvas p-6 mb-8">
            <h3 class="text-xl font-semibold text-glow mb-6">Tambah Agenda MGMP Baru</h3>
            <form id="mgmpAgendaForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Hari</label>
                    <input type="text" id="mgmpHari" class="w-full px-4 py-3 neon-input" placeholder="Contoh: Senin">
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Tanggal</label>
                    <input type="date" id="mgmpTanggal" class="w-full px-4 py-3 neon-input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Waktu</label>
                    <input type="time" id="mgmpWaktu" class="w-full px-4 py-3 neon-input">
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Tempat</label>
                    <input type="text" id="mgmpTempat" class="w-full px-4 py-3 neon-input" placeholder="Lokasi acara">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-glow mb-2">Materi / Bahasan</label>
                    <textarea id="mgmpMateri" rows="3" class="w-full px-4 py-3 neon-input" placeholder="Topik yang dibahas"></textarea>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-glow mb-2">Dokumentasi (Link)</label>
                    <input type="text" id="mgmpDokumentasi" class="w-full px-4 py-3 neon-input" placeholder="Link foto atau dokumen">
                </div>
                <div class="md:col-span-2">
                    <button type="submit" class="btn-primary px-6 py-3 rounded-lg font-semibold">
                        <i class="fas fa-plus mr-2"></i>Tambah Agenda MGMP
                    </button>
                </div>
            </form>
        </div>

        <div class="neon-canvas p-6">
            <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0 mb-6">
                <h3 class="text-xl font-semibold text-white">Daftar Agenda MGMP</h3>
                <button onclick="printData('mgmpAgenda')" class="btn-primary px-4 py-2 rounded-lg text-white text-sm">
                    <i class="fas fa-print mr-2"></i>Cetak
                </button>
            </div>
            <div id="mgmpAgendaList" class="space-y-4">
                </div>
        </div>
    </div>

    <div id="mgmpNotulenTab" class="hidden">
        <div class="neon-canvas p-6">
            <h3 class="text-xl font-semibold text-glow mb-6">Buat Notulen Rapat Baru</h3>
            <form id="notulenForm" class="space-y-6">
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        <div>
            <label class="block text-sm font-medium text-glow mb-2">Rapat Ke</label>
            <input type="text" id="notulenKe" class="w-full px-4 py-3 neon-input" placeholder="Contoh: 4">
        </div>
        <div>
            <label class="block text-sm font-medium text-glow mb-2">Hari</label>
            <input type="text" id="notulenHari" class="w-full px-4 py-3 neon-input" placeholder="Contoh: Selasa">
        </div>
        <div>
            <label class="block text-sm font-medium text-glow mb-2">Tanggal</label>
            <input type="date" id="notulenTanggal" class="w-full px-4 py-3 neon-input">
        </div>
        <div>
            <label class="block text-sm font-medium text-glow mb-2">Waktu</label>
            <input type="time" id="notulenWaktu" class="w-full px-4 py-3 neon-input">
        </div>
        <div class="md:col-span-2">
            <label class="block text-sm font-medium text-glow mb-2">Tempat</label>
            <input type="text" id="notulenTempat" class="w-full px-4 py-3 neon-input" placeholder="Contoh: Ruang Guru">
        </div>
        <div class="lg:col-span-3">
            <label class="block text-sm font-medium text-glow mb-2">Agenda Rapat</label>
            <input type="text" id="notulenAgenda" class="w-full px-4 py-3 neon-input" placeholder="Topik utama rapat">
        </div>
        <div>
            <label class="block text-sm font-medium text-glow mb-2">Pimpinan Rapat</label>
            <input type="text" id="notulenPimpinan" class="w-full px-4 py-3 neon-input" placeholder="Nama pimpinan">
        </div>
        <div>
            <label class="block text-sm font-medium text-glow mb-2">Jml. Peserta</label>
            <input type="number" id="notulenPeserta" class="w-full px-4 py-3 neon-input" placeholder="Angka">
        </div>
        <div>
            <label class="block text-sm font-medium text-glow mb-2">Jml. Hadir</label>
            <input type="number" id="notulenHadir" class="w-full px-4 py-3 neon-input" placeholder="Angka">
        </div>
        <div class="lg:col-span-2">
            <label class="block text-sm font-medium text-glow mb-2">Jml. Tdk Hadir</label>
            <input type="number" id="notulenTidakHadir" class="w-full px-4 py-3 neon-input" placeholder="Angka">
        </div>
        <div class="lg:col-span-3">
            <label class="block text-sm font-medium text-glow mb-2">Keterangan Tidak Hadir</dabel>
            <input type="text" id="notulenKeterangan" class="w-full px-4 py-3 neon-input" placeholder="Nama guru / alasan">
        </div>
    </div>
    
    <div class="border-t border-purple-500 pt-6">
        <h4 class="text-lg font-semibold text-glow mb-4">Hasil Rapat</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-glow mb-2">Refleksi / Evaluasi</label>
                <textarea id="notulenRefleksi" rows="5" class="w-full neon-input p-3" placeholder="Tuliskan hasil refleksi..."></textarea>
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-2">Tindak Lanjut</label>
                <textarea id="notulenTindakLanjut" rows="5" class="w-full neon-input p-3" placeholder="Tuliskan rencana tindak lanjut..."></textarea>
            </div>
        </div>
    </div>

    <div>
        <button type="submit" class="btn-primary px-6 py-3 rounded-lg font-semibold">
            <i class="fas fa-save mr-2"></i>Simpan Notulen
        </button>
    </div>
            </form>
    </div>

            <div class="neon-canvas p-6">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center space-y-4 sm:space-y-0 mb-6">
            <h3 class="text-xl font-semibold text-white">Daftar Notulen Tersimpan</h3>
            <button onclick="printData('notulen')" class="btn-primary px-4 py-2 rounded-lg text-white text-sm">
                <i class="fas fa-print mr-2"></i>Cetak Semua
            </button>
        </div>
        <div id="notulenList" class="space-y-4">
            </div>
    </div>
    </div>
</div>

<!-- PROFILE PAGE -->
<div id="profilPage" class="page-content p-6 hidden">
    <div class="mb-8">
        <h2 class="text-3xl font-bold text-white mb-2">Profil Saya</h2>
        <p class="text-gray-400">Kelola informasi akun dan keamanan Anda</p>
    </div>

    <div class="neon-canvas p-6 mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <label class="block text-sm font-medium text-gray-400">Nama Lengkap</label>
                <p id="profilNamaLengkap" class="text-xl text-glow font-semibold mt-1"></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400">NIP / NIPPPK</label>
                <p id="profilNip" class="text-xl text-glow font-semibold mt-1"></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400">Username</label>
                <p id="profilUsername" class="text-xl text-glow font-semibold mt-1"></p>
            </div>
        </div>
    </div>

    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
        <button onclick="openEditProfileModal()" class="btn-primary w-full sm:w-auto">
            <i class="fas fa-edit mr-2"></i>Ubah Profil
        </button>
        <button onclick="openChangePasswordModal()" class="btn-secondary w-full sm:w-auto">
            <i class="fas fa-key mr-2"></i>Ubah Password
        </button>
    </div>
</div>

</main>
    </div>


<!-- MODAL MAPEL -->
    <div id="mapelModal" class="notification-container">
    <div class="notification-popup neon-canvas w-full max-w-md">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-xl font-semibold text-glow">Kelola Mata Pelajaran</h3>
            <button onclick="closeMapelModal()" class="text-2xl hover:text-red-500 transition-colors">&times;</button>
        </div>

        <div id="mapelListContainer" class="space-y-3 text-left mb-6 max-h-60 overflow-y-auto pr-2">
            </div>

        <div class="flex space-x-3">
            <input type="text" id="newMapelInput" class="w-full px-4 py-3 neon-input" placeholder="Nama Mapel Baru...">
            <button onclick="tambahMapelBaru()" class="btn-primary px-6 py-3 rounded-lg text-white font-semibold whitespace-nowrap">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>
</div>

<!-- MODAL POP UP PASSWORD MENU MGMP -->
<div id="passwordModal" class="notification-container">
    <div class="neon-canvas p-8 w-full max-w-md">
        <h3 class="text-xl font-semibold text-glow mb-2 text-center">Akses Terbatas</h3>
        <p class="text-center text-gray-400 mb-6">Silakan masukkan kata sandi untuk membuka menu MGMP.</p>
        
        <form id="mgmpPasswordForm" class="space-y-4">
            <input type="password" id="mgmpPasswordInput" class="w-full px-4 py-3 neon-input text-center" placeholder="••• Kata Sandi •••">
            
            <div class="flex space-x-4 pt-4">
                <button type="button" onclick="closePasswordModal()" class="w-full btn-secondary py-3 rounded-lg font-semibold">
                    Batal
                </button>
                <button type="submit" class="w-full btn-primary py-3 rounded-lg font-semibold"> 
                    Masuk
                </button>
            </div>
        </form>
    </div>
</div>

<!-- modal notifikasi -->
<div id="confirmationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 sm:w-auto max-w-md animate-fade-in text-center">
        <div class="text-yellow-400 text-5xl mb-4">
            <i class="fas fa-exclamation-triangle"></i>
        </div>
        
        <h3 class="text-lg sm:text-xl font-semibold text-glow mb-2">Konfirmasi Tindakan</h3>
        <p id="modalMessage" class="text-white mb-6">Apakah Anda yakin?</p>
        
        <div class="flex justify-center space-x-4">
            <button id="confirmNoBtn" class="btn-secondary w-28">Batal</button>
            
            <button id="confirmYesBtn" class="btn-danger w-28">Ya, Hapus</button>
        </div>
    </div>
</div>


<!------- MODAL LIHAT DETAIL PENILAIAN------->
<div id="penilaianDetailModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 max-w-2xl animate-fade-in flex flex-col" style="max-height: 90vh;">
        <div class="flex justify-between items-center mb-4">
            <h3 id="modalDetailTitle" class="text-lg sm:text-xl font-semibold text-glow">Detail Nilai</h3>
            <button onclick="closePenilaianDetailModal()" class="text-2xl text-glow hover:text-white">&times;</button>
        </div>
        
        <div class="overflow-y-auto">
            <table class="w-full text-left min-w-full">
                <thead>
                    <tr class="border-b border-gray-700">
                        <th class="pb-4 pr-4 text-glow" style="width: 50px;">No</th>
                        <th class="pb-4 pr-4 text-glow">Nama Siswa</th>
                        <th class="pb-4 text-glow text-center" style="width: 100px;">Nilai</th>
                    </tr>
                </thead>
                <tbody id="modalDetailTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>


<!-- pop up edit agenda -->
<div id="editAgendaModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 max-w-2xl animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg sm:text-xl font-semibold text-glow">Edit Agenda Guru</h3>
            <button onclick="closeEditAgendaModal()" class="text-2xl text-glow hover:text-white">&times;</button>
        </div>

        <form id="editAgendaForm">
            <input type="hidden" id="editAgendaTimestamp">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="date" id="editAgendaTanggal" class="neon-input" required>
                <input type="time" id="editAgendaWaktu" class="neon-input" required>
                
                <select id="editAgendaMapel" class="neon-input"></select>
                
                <select id="editAgendaKelas" class="neon-input">
                    <option value="7.1">7.1</option>
                    <option value="7.2">7.2</option>
                    <option value="7.3">7.3</option>
                    <option value="7.4">7.4</option>
                    <option value="8.1">8.1</option>
                    <option value="8.2">8.2</option>
                    <option value="8.3">8.3</option>
                    <option value="8.4">8.4</option>
                    <option value="9.1">9.1</option>
                    <option value="9.2">9.2</option>
                    <option value="9.3">9.3</option>
                    <option value="9.4">9.4</option>
                </select>
                
                <textarea id="editAgendaMateri" rows="3" class="neon-input md:col-span-2" placeholder="Materi/Kegiatan..." required></textarea>
                
                <select id="editAgendaJenis" class="neon-input md:col-span-2">
                    <option value="Pembelajaran">Pembelajaran</option>
                    <option value="Ulangan">Ulangan</option>
                    <option value="Praktikum">Praktikum</option>
                    <option value="Diskusi">Diskusi</option>
                    <option value="Presentasi">Presentasi</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
            <div class="text-right mt-6">
                <button type="submit" class="btn-primary">
                    <span class="btn-text">Simpan Perubahan</span>
                    <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- POP UP EDIT JURNAL-->
<div id="editJurnalModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 max-w-3xl animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg sm:text-xl font-semibold text-glow">Edit Jurnal Guru</h3>
            <button onclick="closeEditJurnalModal()" class="text-2xl text-glow hover:text-white">&times;</button>
        </div>

        <form id="editJurnalForm">
            <input type="hidden" id="editJurnalTimestamp">
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="date" id="editJurnalTanggal" class="neon-input" required>
                <input type="number" id="editJurnalJam" class="neon-input" placeholder="Jam Ke..." required>
                <select id="editJurnalMapel" class="neon-input"></select>
                
                <select id="editJurnalKelas" class="neon-input">
                    <option value="7.1">7.1</option>
                    <option value="7.2">7.2</option>
                    <option value="7.3">7.3</option>
                    <option value="7.4">7.4</option>
                    <option value="8.1">8.1</option>
                    <option value="8.2">8.2</option>
                    <option value="8.3">8.3</option>
                    <option value="8.4">8.4</option>
                    <option value="9.1">9.1</option>
                    <option value="9.2">9.2</option>
                    <option value="9.3">9.3</option>
                    <option value="9.4">9.4</option>
                </select>
                
                <input type="number" id="editJurnalHadir" class="neon-input" placeholder="Jumlah Hadir" required>
                <input type="number" id="editJurnalTidakHadir" class="neon-input" placeholder="Jumlah Tidak Hadir" required>
                <textarea id="editJurnalMateri" rows="3" class="neon-input md:col-span-3" placeholder="Materi/Kegiatan..." required></textarea>
                <textarea id="editJurnalCatatan" rows="2" class="neon-input md:col-span-3" placeholder="Catatan (opsional)"></textarea>
            </div>
            <div class="text-right mt-6">
                <button type="submit" class="btn-primary">
                    <span class="btn-text">Simpan Perubahan</span>
                    <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- POP UP EDIT DATA SISWA -->
<div id="editSiswaModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 max-w-lg animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg sm:text-xl font-semibold text-glow">Edit Data Siswa</h3>
            <button onclick="closeSiswaEditModal()" class="text-2xl text-glow hover:text-white">&times;</button>
        </div>

        <form id="editSiswaForm">
            <input type="hidden" id="editSiswaTimestamp">
            
            <div class="space-y-4">
                <div>
                    <label for="editSiswaNama" class="block text-sm font-medium text-glow mb-2">Nama Siswa</label>
                    <input type="text" id="editSiswaNama" class="neon-input w-full" required>
                </div>
                <div>
                    <label for="editSiswaKelas" class="block text-sm font-medium text-glow mb-2">Kelas</label>
                    <select id="editSiswaKelas" class="neon-input w-full">
                        <option value="7.1">7.1</option>
                        <option value="7.2">7.2</option>
                        <option value="7.3">7.3</option>
                        <option value="7.4">7.4</option>
                        <option value="8.1">8.1</option>
                        <option value="8.2">8.2</option>
                        <option value="8.3">8.3</option>
                        <option value="8.4">8.4</option>
                        <option value="9.1">9.1</option>
                        <option value="9.2">9.2</option>
                        <option value="9.3">9.3</option>
                        <option value="9.4">9.4</option>
                    </select>
                </div>
            </div>
            <div class="text-right mt-6">
                <button type="submit" class="btn-primary">
                    <span class="btn-text">Simpan Perubahan</span>
                    <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- POP UP PENILAIAN -->
<div id="editPenilaianModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 max-w-3xl animate-fade-in flex flex-col" style="max-height: 90vh;">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg sm:text-xl font-semibold text-glow">Edit Penilaian</h3>
            <button onclick="closeEditPenilaianModal()" class="text-2xl text-glow hover:text-white">&times;</button>
        </div>

        <form id="editPenilaianForm">
            <input type="hidden" id="editPenilaianTimestamp"> 
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6 pb-6 border-b border-gray-700">
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Keterangan</label>
                    <input type="text" id="editPenilaianKeterangan" class="neon-input w-full bg-gray-800" readonly>
                </div>
                <div>
                    <label class="block text-sm font-medium text-glow mb-2">Kelas</label>
                    <input type="text" id="editPenilaianKelas" class="neon-input w-full bg-gray-800" readonly>
                </div>
            </div>

            <h4 class="text-md font-semibold text-glow mb-4">Edit Nilai Siswa</h4>
            <div id="editPenilaianSiswaList" class="max-h-60 overflow-y-auto pr-2">
                </div>

            <div class="text-right mt-6">
                <button type="submit" class="btn-primary">
                    <span class="btn-text">Simpan Perubahan</span>
                    <span class="btn-loading hidden"><div class="loading mr-2"></div>Menyimpan...</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- POP UP EDIT AGENDA MGMP -->
<div id="editMgmpAgendaModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 max-w-2xl animate-fade-in">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg sm:text-xl font-semibold text-glow">Edit Agenda MGMP</h3>
            <button onclick="closeEditMgmpAgendaModal()" class="text-2xl text-glow hover:text-white">&times;</button>
        </div>

        <form id="editMgmpAgendaForm" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <input type="hidden" id="editMgmpAgendaTimestamp">
            <div>
                <label class="block text-sm font-medium text-glow mb-2">Hari</label>
                <input type="text" id="editMgmpHari" class="w-full px-4 py-3 neon-input" placeholder="Contoh: Senin">
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-2">Tanggal</label>
                <input type="date" id="editMgmpTanggal" class="w-full px-4 py-3 neon-input">
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-2">Waktu</label>
                <input type="time" id="editMgmpWaktu" class="w-full px-4 py-3 neon-input">
            </div>
            <div>
                <label class="block text-sm font-medium text-glow mb-2">Tempat</label>
                <input type="text" id="editMgmpTempat" class="w-full px-4 py-3 neon-input" placeholder="Lokasi acara">
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-glow mb-2">Materi / Bahasan</label>
                <textarea id="editMgmpMateri" rows="3" class="w-full px-4 py-3 neon-input" placeholder="Topik yang dibahas"></textarea>
            </div>
            <div class="md:col-span-2">
                <label class="block text-sm font-medium text-glow mb-2">Dokumentasi (Link)</label>
                <input type="text" id="editMgmpDokumentasi" class="w-full px-4 py-3 neon-input" placeholder="Link foto atau dokumen">
            </div>
            <div class="md:col-span-2 text-right">
                <button type="submit" class="btn-primary">
                    <span class="btn-text">Simpan Perubahan</span>
                </button>
            </div>
        </form>
    </div>
</div>

<!-- POP UP EDIT NOTULEN -->
<div id="editNotulenModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-6 sm:p-8 rounded-lg shadow-lg w-11/12 max-w-4xl animate-fade-in flex flex-col" style="max-height: 90vh;">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-lg sm:text-xl font-semibold text-glow">Edit Notulen Rapat</h3>
            <button onclick="closeEditNotulenModal()" class="text-2xl text-glow hover:text-white">&times;</button>
        </div>
        
        <form id="editNotulenForm" class="overflow-y-auto pr-2">
            <input type="hidden" id="editNotulenTimestamp">
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div><label class="block text-sm text-glow mb-2">Rapat Ke</label><input type="text" id="editNotulenKe" class="w-full neon-input p-3"></div>
                    <div><label class="block text-sm text-glow mb-2">Hari</label><input type="text" id="editNotulenHari" class="w-full neon-input p-3"></div>
                    <div><label class="block text-sm text-glow mb-2">Tanggal</label><input type="date" id="editNotulenTanggal" class="w-full neon-input p-3"></div>
                    <div><label class="block text-sm text-glow mb-2">Waktu</label><input type="time" id="editNotulenWaktu" class="w-full neon-input p-3"></div>
                    <div class="md:col-span-2"><label class="block text-sm text-glow mb-2">Tempat</label><input type="text" id="editNotulenTempat" class="w-full neon-input p-3"></div>
                    <div class="lg:col-span-3"><label class="block text-sm text-glow mb-2">Agenda Rapat</label><input type="text" id="editNotulenAgenda" class="w-full neon-input p-3"></div>
                    <div><label class="block text-sm text-glow mb-2">Pimpinan Rapat</label><input type="text" id="editNotulenPimpinan" class="w-full neon-input p-3"></div>
                    <div><label class="block text-sm text-glow mb-2">Jml. Peserta</label><input type="number" id="editNotulenPeserta" class="w-full neon-input p-3"></div>
                    <div><label class="block text-sm text-glow mb-2">Jml. Hadir</label><input type="number" id="editNotulenHadir" class="w-full neon-input p-3"></div>
                    <div class="lg:col-span-2"><label class="block text-sm text-glow mb-2">Jml. Tdk Hadir</label><input type="number" id="editNotulenTidakHadir" class="w-full neon-input p-3"></div>
                    <div class="lg:col-span-3"><label class="block text-sm text-glow mb-2">Keterangan Tidak Hadir</label><input type="text" id="editNotulenKeterangan" class="w-full neon-input p-3"></div>
                </div>
                <div class="border-t border-purple-500 pt-6">
                    <h4 class="text-lg font-semibold text-glow mb-4">Hasil Rapat</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div><label class="block text-sm text-glow mb-2">Refleksi / Evaluasi</label><textarea id="editNotulenRefleksi" rows="5" class="w-full neon-input p-3"></textarea></div>
                        <div><label class="block text-sm text-glow mb-2">Tindak Lanjut</label><textarea id="editNotulenTindakLanjut" rows="5" class="w-full neon-input p-3"></textarea></div>
                    </div>
                </div>
            </div>
            <div class="text-right mt-6">
                <button type="submit" class="btn-primary">Simpan Perubahan</button>
            </div>
        </form>
    </div>
</div>

<!-- EDIT PROFILE DAN PASSOWRD MODAL --->
<div id="editProfileModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-8 w-full max-w-lg">
        <h3 class="text-xl font-semibold text-glow mb-6">Ubah Detail Profil</h3>
        <form id="editProfileForm" class="space-y-4">
            <div>
                <label class="block text-sm text-glow mb-2">Nama Lengkap & Gelar</label>
                <input type="text" id="editNamaLengkap" class="w-full neon-input p-3" required>
            </div>
            <div>
                <label class="block text-sm text-glow mb-2">NIP / NIPPPK</label>
                <input type="text" id="editNip" class="w-full neon-input p-3">
            </div>
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeEditProfileModal()" class="btn-secondary">Batal</button>
                <button type="submit" class="btn-primary">Simpan Perubahan</button>
            </div>
        </form>
    </div>
</div>
<div id="changePasswordModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 hidden">
    <div class="neon-canvas p-8 w-full max-w-lg">
        <h3 class="text-xl font-semibold text-glow mb-6">Ubah Password</h3>
        <form id="changePasswordForm" class="space-y-4">
            <div>
                <label class="block text-sm text-glow mb-2">Password Lama</label>
                <input type="password" id="oldPassword" class="w-full neon-input p-3" required>
            </div>
            <div>
                <label class="block text-sm text-glow mb-2">Password Baru</label>
                <input type="password" id="newPassword" class="w-full neon-input p-3" required>
            </div>
            <div>
                <label class="block text-sm text-glow mb-2">Konfirmasi Password Baru</label>
                <input type="password" id="confirmNewPassword" class="w-full neon-input p-3" required>
            </div>
            <div class="flex justify-end space-x-4 pt-4">
                <button type="button" onclick="closeChangePasswordModal()" class="btn-secondary">Batal</button>
                <button type="submit" class="btn-primary">Ubah Password</button>
            </div>
        </form>
    </div>
</div>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

    <script>

        // Fungsi untuk menampilkan loading spinner
function showLoadingSpinner() {
    document.getElementById('loadingOverlay').classList.remove('hidden');
}

// Fungsi untuk menyembunyikan loading spinner
function hideLoadingSpinner() {
    document.getElementById('loadingOverlay').classList.add('hidden');
}


        // Configuration - Replace with your Google Apps Script Web App URL
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbym9UjzmC_QSrixQAPcTbQrJ_WikzGyX2L4G6zq9IGrnpRbNDPwWsuICUf0FZC-EFCpXg/exec';


        
// ================================================================= //
// ==           FUNGSI BARU UNTUK KOMUNIKASI DENGAN SERVER        == //
// ================================================================= //
async function callAppsScript(action, payload = {}) {
    const token = localStorage.getItem('userToken') || '';
    showLoadingSpinner(); 

    try {
        const params = new URLSearchParams({
            action: action,
            token: token,
            data: JSON.stringify(payload)
        });
        
        const response = await fetch(`${GOOGLE_SCRIPT_URL}?${params.toString()}`, {
            method: 'GET',
            redirect: 'follow'
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();

        if (result.success === false) {
            throw new Error(result.error);
        }
        
        return result;

    } catch (error) {
        console.error(`Error pada aksi '${action}':`, error);
        const simpleMessage = error.message.split(':').pop().trim();
        showNotification(simpleMessage, 'error');
        return { success: false, error: error.message };
    } finally {
        hideLoadingSpinner();
    }
}

        // Sample data
        const sampleStudents = [
            'Ahmad Rizki', 'Siti Nurhaliza', 'Budi Santoso', 'Dewi Sartika', 'Eko Prasetyo',
            'Fitri Handayani', 'Gilang Ramadhan', 'Hana Pertiwi', 'Indra Gunawan', 'Joko Widodo',
            'Kartika Sari', 'Lukman Hakim', 'Maya Sari', 'Nanda Pratama', 'Oki Setiana',
            'Putri Ayu', 'Qori Sumantri', 'Rina Marlina', 'Sandi Permana', 'Tari Melati',
            'Umar Bakri', 'Vina Panduwinata', 'Wawan Setiawan', 'Xenia Gratia', 'Yudi Latif',
            'Zahra Aulia', 'Andi Lala', 'Bayu Skak', 'Citra Kirana', 'Doni Salmanan'
        ];

        let currentAgendaData = [];
        let currentJurnalData = [];
        let currentAbsensiData = [];
        let currentPenilaianData = [];
        let currentSiswaData = [];
        let mataPelajaranList = [];
        let currentMgmpAgendaData = [];
        let currentMgmpNotulenData = [];

        // Enhanced date normalization function to handle different date formats
        function normalizeDate(dateString) {
            if (!dateString) return '';
            
            // Handle different date formats
            const dateStr = String(dateString).trim();
            console.log('Normalizing date:', dateStr);
            
            // If already in YYYY-MM-DD format
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                console.log('Already normalized:', dateStr);
                return dateStr;
            }
            
            // If in DD/MM/YYYY format
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                const day = parts[0].padStart(2, '0');
                const month = parts[1].padStart(2, '0');
                const year = parts[2];
                const normalized = `${year}-${month}-${day}`;
                console.log('DD/MM/YYYY normalized:', dateStr, '->', normalized);
                return normalized;
            }
            
            // If in MM/DD/YYYY format (Google Sheets sometimes uses this)
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                try {
                    // Try parsing as MM/DD/YYYY first
                    const parts = dateStr.split('/');
                    if (parts.length === 3) {
                        const month = parts[0].padStart(2, '0');
                        const day = parts[1].padStart(2, '0');
                        const year = parts[2];
                        const normalized = `${year}-${month}-${day}`;
                        console.log('MM/DD/YYYY normalized:', dateStr, '->', normalized);
                        return normalized;
                    }
                } catch (e) {
                    console.error('Error parsing MM/DD/YYYY date:', dateStr, e);
                }
            }
            
            // Handle Google Sheets date format (e.g., "1/25/2025")
            if (/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateStr)) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    // Assume MM/DD/YYYY format from Google Sheets
                    const month = parts[0].padStart(2, '0');
                    const day = parts[1].padStart(2, '0');
                    const year = parts[2];
                    const normalized = `${year}-${month}-${day}`;
                    console.log('Google Sheets format normalized:', dateStr, '->', normalized);
                    return normalized;
                }
            }
            
            // Try to parse as Date object
            try {
                const date = new Date(dateStr);
                if (!isNaN(date.getTime())) {
                    // Adjust for timezone to get local date
                    const localDate = new Date(date.getTime() - (date.getTimezoneOffset() * 60000));
                    const normalized = localDate.toISOString().split('T')[0];
                    console.log('Date object normalized:', dateStr, '->', normalized);
                    return normalized;
                }
            } catch (e) {
                console.error('Error parsing date object:', dateStr, e);
            }
            
            console.warn('Could not normalize date:', dateStr);
            return dateStr; // Return as-is if can't normalize
        }

        // Function to compare dates with flexible matching
        function datesMatch(date1, date2, matchType = 'exact') {
            const norm1 = normalizeDate(date1);
            const norm2 = normalizeDate(date2);
            
            console.log('Comparing dates:', { date1, date2, norm1, norm2, matchType });
            
            if (matchType === 'exact') {
                return norm1 === norm2;
            } else if (matchType === 'month') {
                return norm1.substring(0, 7) === norm2.substring(0, 7); // YYYY-MM
            }
            
            return false;
        }

        // Google Sheets Integration Functions
        // Authentication
document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;

    // Panggil backend untuk aksi 'login'
    const result = await callAppsScript('login', { username, password });

    if (result.success) {
        // Jika login berhasil, simpan token dan data user
        localStorage.setItem('userToken', result.token);
        localStorage.setItem('userData', JSON.stringify(result.user));

        // Tampilkan nama user di header (opsional, tapi bagus)
        document.getElementById('userNameDisplay').textContent = result.user.namaLengkap;

        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        showNotification('Login berhasil!', 'success');

        // Muat data awal setelah login berhasil
        initializeSampleData(); 
    } 
    // Pesan error (misal: "Username atau password salah") sudah otomatis
    // ditampilkan oleh fungsi callAppsScript, jadi tidak perlu blok 'else'.
});

        // Button loading state management
        function setButtonLoading(button, loading) {
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            if (loading) {
                btnText.classList.add('hidden');
                btnLoading.classList.remove('hidden');
                button.disabled = true;
            } else {
                btnText.classList.remove('hidden');
                btnLoading.classList.add('hidden');
                button.disabled = false;
            }
        }

// ===== FUNGSI AKSES MENU MGMP (BARU MENGGUNAKAN MODAL) =====

function aksesMenuMGMP() {
    openPasswordModal();
}

// ===== TIGA FUNGSI BARU UNTUK AKSES MENU MGMP =====

function openPasswordModal() {
    document.getElementById('passwordModal').classList.add('show');
    // Otomatis fokus ke input password saat modal terbuka
    document.getElementById('mgmpPasswordInput').focus();
    // Tambahkan baris ini untuk "mendengarkan" event submit
    document.getElementById('mgmpPasswordForm').addEventListener('submit', checkMgmpPassword);
}

function closePasswordModal() {
    document.getElementById('passwordModal').classList.remove('show');
    // Kosongkan input password saat modal ditutup
    document.getElementById('mgmpPasswordInput').value = '';
}

function checkMgmpPassword(event) {
    event.preventDefault(); // Baris ini PENTING untuk mencegah halaman reload
    const passwordKhusus = 'mgmp58'; // Password Anda tetap di sini
    const passwordInput = document.getElementById('mgmpPasswordInput').value;

    if (passwordInput === passwordKhusus) {
        // Jika password benar, tutup modal dan buka halaman MGMP
        closePasswordModal();
        showPage('mgmp');
    } else {
        // Jika password salah, tampilkan notifikasi error
        showNotification('Kata sandi salah!', 'error');
        // Kosongkan input untuk percobaan berikutnya
        document.getElementById('mgmpPasswordInput').value = '';
        document.getElementById('mgmpPasswordInput').focus();
    }
}
// ===========================================

// =====================================

        // Initialize sample data
// GANTI FUNGSI LAMA ANDA DENGAN YANG BARU INI

async function initializeSampleData() {
    try {
        // Load existing data from Google Sheets secara bersamaan
        const [
            agendaResponse,
            jurnalResponse,
            siswaResponse,
            mgmpAgendaResponse, // Tambahan baru
            notulenResponse,     // Tambahan baru
            penilaianResponse // Tambahkan ini
        ] = await Promise.all([
            callAppsScript('getAgenda'),
            callAppsScript('getJurnal'),
            callAppsScript('getSiswa'),
            callAppsScript('getMgmpAgenda'), // Tambahan baru
            callAppsScript('getNotulen'),     // Tambahan baru
            callAppsScript('getPenilaian') // Tambahkan ini
        ]);
        
        // Memasukkan data ke variabel global
        if (agendaResponse.success) {
            currentAgendaData = agendaResponse.data || [];
        }
        if (jurnalResponse.success) {
            currentJurnalData = jurnalResponse.data || [];
        }
        if (mgmpAgendaResponse.success) {
            currentMgmpAgendaData = mgmpAgendaResponse.data || [];
        }
        if (notulenResponse.success) {
            currentMgmpNotulenData = notulenResponse.data || [];
        }
        if (penilaianResponse.success) {
            currentPenilaianData = penilaianResponse.data || [];
        }
        if (siswaResponse.success && siswaResponse.data && siswaResponse.data.length > 0) {
            currentSiswaData = siswaResponse.data;
        }
        // === TAMBAHKAN KODE VERIFIKASI DI SINI ===
        console.log("--- VERIFIKASI DATA SETELAH FETCH ---");
        console.log("Data Agenda yang diterima:", currentAgendaData);
        console.log("Data Siswa yang diterima:", currentSiswaData);
        console.log("Data Jurnal yang diterima:", currentJurnalData);
        console.log("-------------------------------------");
        // ===========================================


        // Panggil semua fungsi untuk menampilkan data di awal
        displayAgendaList();
        displayJurnalList();
        displaySiswaList();
        displayMgmpAgendaList(); // Fungsi ini perlu kita buat
        displayNotulenList();
        displayPenilaianList(); // Tambahkan pemanggilan fungsi display baru ini
        
    } catch (error) {
        console.error('Error loading initial data:', error);
        showNotification('Gagal memuat semua data awal.', 'error');
    }
}


// 'showPage' 
function showPage(page) {
    document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
    
    const pageIds = {
        'beranda': 'berandaPage',
        'agenda-guru': 'agendaGuruPage',
        'jurnal-guru': 'jurnalGuruPage',
        'siswa': 'siswaPage',
        'absensi': 'absensiPage',
        'penilaian': 'penilaianPage',
        'rekapan': 'rekapanPage',
        'mgmp': 'mgmpPage',
        'profil': 'profilPage' // Pastikan 'profil' ada di sini
    };
    
    const targetPage = document.getElementById(pageIds[page]);
    if (targetPage) {
        targetPage.classList.remove('hidden');
    }
    
    const titles = {
        'beranda': 'Beranda',
        'agenda-guru': 'Agenda Guru',
        'jurnal-guru': 'Jurnal Guru',
        'siswa': 'Data Siswa',
        'absensi': 'Absensi Siswa',
        'penilaian': 'Penilaian Siswa',
        'rekapan': 'Rekapan Data',
        'mgmp': 'MGMP',
        'profil': 'Profil Saya' // Pastikan 'profil' ada di sini
    };
    document.getElementById('pageTitle').textContent = titles[page];
    
    closeSidebar();

    // Pastikan blok 'if' ini ada di akhir fungsi
    if (page === 'profil') {
        loadProfileData();
    }
}


// 2. PASTIKAN SEMUA FUNGSI DI BAWAH INI ADA DI SCRIPT ANDA

// Fungsi untuk memuat data ke halaman profil
function loadProfileData() {
    const userData = JSON.parse(localStorage.getItem('userData'));
    if (userData) {
        document.getElementById('profilNamaLengkap').textContent = userData.namaLengkap || '-';
        document.getElementById('profilNip').textContent = userData.nip || '-';
        document.getElementById('profilUsername').textContent = userData.username || '-';
    }
}

// Fungsi untuk membuka & menutup modal edit profil
function openEditProfileModal() {
    const userData = JSON.parse(localStorage.getItem('userData'));
    if (userData) {
        document.getElementById('editNamaLengkap').value = userData.namaLengkap;
        document.getElementById('editNip').value = userData.nip;
    }
    document.getElementById('editProfileModal').classList.remove('hidden');
}
function closeEditProfileModal() { document.getElementById('editProfileModal').classList.add('hidden'); }

// Fungsi untuk membuka & menutup modal ubah password
function openChangePasswordModal() { document.getElementById('changePasswordModal').classList.remove('hidden'); }
function closeChangePasswordModal() { document.getElementById('changePasswordModal').classList.add('hidden'); }


// 3. PASTIKAN SEMUA EVENT LISTENER INI ADA DI BAGIAN BAWAH SCRIPT ANDA

// Event listener untuk form edit profil
document.getElementById('editProfileForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const newRecord = {
        namaLengkap: document.getElementById('editNamaLengkap').value,
        nip: document.getElementById('editNip').value
    };
    const result = await callAppsScript('updateUserProfile', { newRecord: newRecord });
    if (result.success) {
        localStorage.setItem('userData', JSON.stringify(result.updatedUser));
        
        // Panggil fungsi update UI di sini juga
        updateUserUI(); 
        
        loadProfileData();
        closeEditProfileModal();
        showNotification('Profil berhasil diperbarui!', 'success');
    }
});

// Event listener untuk form ubah password
document.getElementById('changePasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const oldPassword = document.getElementById('oldPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;

    if (newPassword !== confirmNewPassword) {
        showNotification('Password baru dan konfirmasi tidak cocok!', 'error');
        return;
    }
    
    const result = await callAppsScript('changePassword', { oldPassword: oldPassword, newPassword: newPassword });
    if (result.success) {
        closeChangePasswordModal();
        this.reset();
        showNotification('Password berhasil diubah!', 'success');
    }
});

        // Navigation
        // Sidebar functionality
        document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebar);

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            
            if (sidebar.classList.contains('-translate-x-full')) {
                openSidebar();
            } else {
                closeSidebar();
            }
        }

        function openSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            sidebar.classList.remove('-translate-x-full');
            // Show overlay on all screen sizes when sidebar is open
            overlay.classList.remove('hidden');
        }

        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            
            // Hide sidebar on all screen sizes
            sidebar.classList.add('-translate-x-full');
            overlay.classList.add('hidden');
        }

        // Logout
function logout() {
    // 1. Hapus data sesi dari browser
    localStorage.removeItem('userToken');
    localStorage.removeItem('userData');

    // 2. Tampilkan notifikasi
    showNotification('Logout berhasil!', 'success');

    // 3. Muat ulang halaman setelah notifikasi selesai ditampilkan
    setTimeout(() => {
        window.location.reload();
    }, 1800); // Durasinya sedikit lebih lama dari animasi notifikasi Anda (1500ms)
}

        // Notifications
// HAPUS FUNGSI showNotification LAMA
// function showNotification(message, type) { ... }

// GANTI DENGAN FUNGSI BARU INI
function showNotification(message, type) {
    const container = document.getElementById('notificationContainer');
    const popup = document.getElementById('notificationPopup');
    const icon = document.getElementById('notificationIcon');
    const text = document.getElementById('notificationText');

    // Set Teks dan Tipe
    text.textContent = message;
    popup.className = 'notification-popup neon-canvas ' + type;

    // Set Ikon berdasarkan Tipe Notifikasi
    if (type === 'success') {
        icon.className = 'fas fa-check-circle'; // ✅ Ikon sukses
    } else if (type === 'error') {
        icon.className = 'fas fa-times-circle'; // ❌ Ikon error
    } else {
        icon.className = 'fas fa-info-circle'; // ℹ️ Ikon info
    }

    // Tampilkan notifikasi
    popup.classList.remove('hide');
    container.classList.add('show');

    // Sembunyikan setelah 3 detik
    setTimeout(() => {
        popup.classList.add('hide');
        // Tunggu animasi hide selesai sebelum menyembunyikan container
        setTimeout(() => {
            container.classList.remove('show');
        }, 400); // 400ms cocok dengan durasi animasi neonFadeOut
    }, 1500);
}

// Agenda Guru functionality
// GANTI 'addEventListener' UNTUK 'agendaForm' ANDA DENGAN VERSI SEDERHANA INI
document.getElementById('agendaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    // Hanya mengumpulkan data untuk ditambahkan (tidak ada lagi cek timestamp)
    const agendaData = {
        tanggal: document.getElementById('agendaTanggal').value,
        waktu: document.getElementById('agendaWaktu').value,
        mapel: document.getElementById('agendaMapel').value,
        kelas: document.getElementById('agendaKelas').value,
        materi: document.getElementById('agendaMateri').value,
        jenis: document.getElementById('agendaJenis').value
    };

    const result = await callAppsScript('addAgenda', agendaData);

    if (result.success) {
        // Muat ulang data setelah berhasil
        const response = await callAppsScript('getAgenda');
        if (response.success) {
            currentAgendaData = response.data;
            displayAgendaList();
        }
        this.reset();
        showNotification('Agenda berhasil ditambahkan!', 'success');
    }
    
    setButtonLoading(submitButton, false);
});

// TAMBAHKAN FUNGSI BARU INI DI DALAM <script> ANDA
function formatTanggal(isoString) {
    if (!isoString) return ''; // Mengembalikan string kosong jika data tidak ada

    // Buat objek Date dari string ISO
    // JavaScript otomatis mengonversinya ke zona waktu lokal browser Anda
    const tanggalObj = new Date(isoString);

    // Ambil komponen tanggal
    const hari = String(tanggalObj.getDate()).padStart(2, '0');
    const bulan = String(tanggalObj.getMonth() + 1).padStart(2, '0'); // getMonth() dimulai dari 0, jadi perlu +1
    const tahun = tanggalObj.getFullYear();

    // Gabungkan menjadi format yang diinginkan
    return `${hari}/${bulan}/${tahun}`;
}

// Letakkan fungsi baru ini di bawah fungsi formatTanggal
// GANTI FUNGSI LAMA ANDA DENGAN YANG BARU INI

function formatWaktu(waktuString) {
    if (!waktuString) return ''; // Jika data kosong, kembalikan string kosong

    // Cek apakah string mengandung 'T'. Ini menandakan format ISO lengkap dari Google Sheets.
    if (waktuString.includes('T')) {
        const tanggalObj = new Date(waktuString);
        
        // Pastikan hasil konversi adalah tanggal yang valid
        if (isNaN(tanggalObj)) {
            return 'Waktu Invalid';
        }

        const jam = String(tanggalObj.getHours()).padStart(2, '0');
        const menit = String(tanggalObj.getMinutes()).padStart(2, '0');

        return `${jam}:${menit}`;
    }

    // Jika tidak ada 'T', kita anggap formatnya sudah "HH:mm" atau "HH:mm:ss" dari form input.
    // Kita cukup ambil 5 karakter pertama ("HH:mm").
    return waktuString.slice(0, 5);
}      

// FUNGSI AGENDA LIST
function displayAgendaList() {
    console.log("Fungsi displayAgendaList() Dijalankan...");
    const agendaList = document.getElementById('agendaList');
    let filterMapel = '';
    const filterElement = document.getElementById('filterMapelAgenda');
    if (filterElement) {
        filterMapel = filterElement.value;
    }
    agendaList.innerHTML = '';

    const filteredData = filterMapel 
        ? currentAgendaData.filter(item => item.mapel === filterMapel)
        : currentAgendaData;

    // === BARIS BARU: Ambil hanya 10 data teratas ===
    const limitedData = filteredData.slice(0, 10);

    if (limitedData.length === 0) {
        agendaList.innerHTML = `<p class="text-gray-400 text-center py-4">Tidak ada agenda untuk ditampilkan.</p>`;
        return;
    }

    limitedData.forEach((agenda, index) => {
        const agendaCard = document.createElement('div');
        agendaCard.className = 'neon-canvas py-4 px-3 animate-fade-in';
        agendaCard.innerHTML = `<div class="flex flex-col">

        <div class="flex justify-between items-start mb-3 space-x-4">
            <h4 class="flex-1 text-lg font-semibold text-glow break-words">${agenda.materi}</h4>
            <span class="flex-shrink-0 px-3 py-1 bg-purple-600 text-white text-sm rounded-full">${agenda.jenis}</span>
        </div>

        <div class="flex items-end pt-3 border-t border-gray-700 space-x-2">
            
            <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm text-cyan-300">
                <div><i class="fas fa-calendar mr-2"></i>${formatTanggal(agenda.tanggal)}</div>
                <div><i class="fas fa-clock mr-2"></i>${formatWaktu(agenda.waktu)}</div>
                <div><i class="fas fa-book mr-2"></i>${agenda.mapel}</div>
                <div><i class="fas fa-users mr-2"></i>Kelas ${agenda.kelas}</div>
            </div>

                    <div class="flex items-center space-x-2">
                        <button data-timestamp="${agenda.Timestamp}" class="edit-agenda-btn icon-button btn-secondary p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-pencil-alt text-xs"></i>
                            <span class="tooltip-text">Edit</span>
                        </button>
                        <button data-timestamp="${agenda.Timestamp}" class="delete-agenda-btn icon-button btn-danger p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-trash-alt text-xs"></i>
                            <span class="tooltip-text">Hapus</span>
                        </button>
                    </div>
        </div>

    </div>
`;
        agendaList.appendChild(agendaCard);
    });
}
// EVENT LISTENER AGENDA CLICK
document.getElementById('agendaList').addEventListener('click', function (event) {
    const editButton = event.target.closest('.edit-agenda-btn');
    const deleteButton = event.target.closest('.delete-agenda-btn');

    if (editButton) {
        const timestamp = editButton.dataset.timestamp;
        openAgendaEditModal(timestamp); // Panggil fungsi edit
    }

    if (deleteButton) {
        const timestamp = deleteButton.dataset.timestamp;
        deleteAgendaItem(timestamp); // Panggil fungsi hapus
    }
});


// Jurnal Guru functionality
document.getElementById('jurnalForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    const jurnalData = {
        tanggal: document.getElementById('jurnalTanggal').value,
        jam: document.getElementById('jurnalJam').value,
        mapel: document.getElementById('jurnalMapel').value,
        kelas: document.getElementById('jurnalKelas').value,
        materi: document.getElementById('jurnalMateri').value,
        hadir: parseInt(document.getElementById('jurnalHadir').value),
        tidakHadir: parseInt(document.getElementById('jurnalTidakHadir').value),
        catatan: document.getElementById('jurnalCatatan').value
    };
    
    const result = await callAppsScript('addJurnal', jurnalData);

    if (result.success) {
        const response = await callAppsScript('getJurnal');
        if (response.success) {
            currentJurnalData = response.data;
            displayJurnalList();
        }
        this.reset();
        showNotification('Jurnal berhasil ditambahkan!', 'success');
    }
    
    setButtonLoading(submitButton, false);
});

// FUNGSI JURNAL LIST
function displayJurnalList() {
    const jurnalList = document.getElementById('jurnalList');
    if (!jurnalList) return; // Pengaman

    let filterMapel = document.getElementById('filterMapelJurnal')?.value || '';
    jurnalList.innerHTML = '';

    const filteredData = filterMapel
        ? currentJurnalData.filter(item => item.mapel === filterMapel)
        : currentJurnalData;

    const limitedData = filteredData.slice(0, 10);

    if (limitedData.length === 0) {
        jurnalList.innerHTML = `<p class="text-gray-400 text-center py-4">Tidak ada jurnal untuk ditampilkan.</p>`;
        return;
    }

    limitedData.forEach((jurnal, index) => {
        const jurnalCard = document.createElement('div');
        jurnalCard.className = 'neon-canvas py-4 px-3 animate-fade-in';
        jurnalCard.innerHTML = `
            <div class="flex flex-col">
                <div class="flex justify-between items-start mb-3 space-x-4">
                    <h4 class="flex-1 text-lg font-semibold text-glow break-words">${jurnal.materi}</h4>
                    <span class="flex-shrink-0 px-3 py-1 bg-green-600 text-white text-sm rounded-full">Jam ke-${jurnal.jam}</span>
                </div>

                <div class="flex justify-between items-end pt-3 border-t border-gray-700 space-x-2">
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm text-cyan-300">
                        <div><i class="fas fa-calendar mr-2"></i>${formatTanggal(jurnal.tanggal)}</div>
                        <div><i class="fas fa-book mr-2"></i>${jurnal.mapel}</div>
                        <div><i class="fas fa-users mr-2"></i>Kelas ${jurnal.kelas}</div>
                        <div><i class="fas fa-user-check mr-2"></i>Hadir: ${jurnal.hadir}, Tidak: ${jurnal.tidakHadir}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-timestamp="${jurnal.Timestamp}" class="edit-jurnal-btn icon-button btn-secondary p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-pencil-alt text-xs"></i>
                            <span class="tooltip-text">Edit</span>
                        </button>
                        <button data-timestamp="${jurnal.Timestamp}" class="delete-jurnal-btn icon-button btn-danger p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-trash-alt text-xs"></i>
                            <span class="tooltip-text">Hapus</span>
                        </button>
                    </div>
                </div>
                ${jurnal.catatan ? `<div class="text-sm text-gray-400 italic mt-3 border-t border-gray-700 pt-2"><i class="fas fa-sticky-note mr-2"></i>${jurnal.catatan}</div>` : ''}
            </div>
        `;
        jurnalList.appendChild(jurnalCard);
    });
}
// EVENT LISTENER JURNAL CLICK
// TAMBAHKAN BLOK EVENT LISTENER BARU INI UNTUK JURNAL
document.getElementById('jurnalList').addEventListener('click', function (event) {
    // Cek apakah tombol EDIT yang diklik
    const editButton = event.target.closest('.edit-jurnal-btn');
    if (editButton) {
        const timestamp = editButton.dataset.timestamp;
        openJurnalEditModal(timestamp); // Panggil fungsi edit jurnal
    }

    // Cek apakah tombol HAPUS yang diklik
    const deleteButton = event.target.closest('.delete-jurnal-btn');
    if (deleteButton) {
        const timestamp = deleteButton.dataset.timestamp;
        deleteJurnalItem(timestamp); // Panggil fungsi hapus jurnal
    }
});


// FUNGSI DATA SISWA (TELAH DIHAPUS) DIGANTI LOADDATASISWA
async function loadDataSiswa() {
    const filterKelas = document.getElementById('filterKelas').value;
    showLoadingSpinner(); // Tampilkan spinner saat memuat
    
    try {
        // Minta data ke server HANYA untuk kelas yang dipilih
        const response = await callAppsScript('getSiswa', { kelas: filterKelas });
        
        if (response.success) {
            currentSiswaData = response.data; // Perbarui data global
            displaySiswaList(filterKelas); // Tampilkan data yang baru diterima
        } else {
            // Jika ada error dari server, tampilkan pesan
            showNotification('Gagal memuat data siswa.', 'error');
        }
    } catch (error) {
        console.error('Error loading student data:', error);
        showNotification(`Gagal memuat data: ${error.message}`, 'error');
    } finally {
        hideLoadingSpinner(); // Sembunyikan spinner setelah selesai
    }
}

// FUNGSI displaySiswaList 
function displaySiswaList(filterKelas = '') {
    const siswaTableBody = document.getElementById('siswaTableBody');
    if (!siswaTableBody) {
        console.error("KRUSIAL: Elemen dengan id 'siswaTableBody' TIDAK DITEMUKAN di HTML!");
        return;
    }
    
    siswaTableBody.innerHTML = '';

    let filteredData = currentSiswaData;
    if (filterKelas && filterKelas.trim() !== '') {
        filteredData = currentSiswaData.filter(siswa => {
            const siswaKelas = String(siswa.kelas || '').trim();
            const targetKelas = String(filterKelas).trim();
            return siswaKelas === targetKelas;
        });
    }

    if (filteredData.length === 0) {
        // (kode Anda untuk menampilkan pesan kosong sudah benar)
        siswaTableBody.innerHTML = `
            <tr>
                <td colspan="4" class="py-6 text-center text-gray-400">
                    Tidak ada siswa untuk ditampilkan.
                </td>
            </tr>
        `;
        return;
    }

    filteredData.forEach((siswa, index) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700 animate-fade-in';
        row.innerHTML = `
    <td class="py-4 pr-6 text-glow text-sm sm:text-base">${index + 1}</td>
    
    <td class="py-4 pr-6 text-white text-sm sm:text-base break-words w-full">${siswa.nama}</td>
    
    <td class="py-4 pr-6">
        <span class="px-3 py-1 bg-purple-600 text-white text-xs sm:text-sm rounded-full whitespace-nowrap">Kelas ${siswa.kelas}</span>
    </td>
    <td class="py-4">
        <div class="flex items-center space-x-2">
            <button data-timestamp="${siswa.Timestamp}" class="edit-btn icon-button btn-secondary p-2 h-9 w-9 flex items-center justify-center">
                <i class="fas fa-pencil-alt text-xs"></i>
                <span class="tooltip-text">Edit</span>
            </button>
            
            <button data-nama="${siswa.nama}" data-kelas="${siswa.kelas}" class="hapus-btn icon-button btn-danger p-2 h-9 w-9 flex items-center justify-center">
                <i class="fas fa-trash-alt text-xs"></i>
                <span class="tooltip-text">Hapus</span>
            </button>
        </div>
    </td>
`;
        siswaTableBody.appendChild(row);
    });
}

// FUNGSI HAPUS SISWA
async function hapusSiswa(nama, kelas) {
    if (await showConfirmationModal(`Apakah Anda yakin ingin menghapus ${nama} dari kelas ${kelas}?`)) {
        try {
            const result = await callAppsScript('deleteSiswa', { nama, kelas });

            if (result.success) {
                // PENTING: Setelah berhasil hapus, panggil 'loadDataSiswa'
                // untuk memuat ulang data sesuai dengan filter yang sedang aktif di layar.
                await loadDataSiswa();

                showNotification('Data siswa berhasil dihapus!', 'success');
            }
            // Jika result.success adalah false, notifikasi error dari callAppsScript akan muncul
            
        } catch (error) {
            showNotification('Gagal menghapus data siswa', 'error');
        }
    } else {
        console.log("Pengguna membatalkan penghapusan.");
        showNotification('Penghapusan dibatalkan.', 'success');
    }
}

// Absensi functionality
async function loadAbsensi() {
    const jenisAbsen = document.getElementById('jenisAbsen').value;
    const kelas = document.getElementById('kelasAbsen').value;
    const tanggal = document.getElementById('tanggalAbsen').value;
    
    if (!tanggal) {
        showNotification('Mohon pilih tanggal!', 'error');
        return;
    }
    
    console.log("--- MEMUAT FORM ABSENSI ---");
    console.log(`Kriteria: Kelas=${kelas}, Jenis=${jenisAbsen}, Tanggal=${tanggal}`);
    
    try {
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData) {
            showNotification('Data user tidak ditemukan.', 'error');
            return; 
        }

        const siswaResponse = await callAppsScript('getSiswa', { kelas: kelas });
        if (!siswaResponse.success) { throw new Error('Gagal memuat data siswa.'); }
        const siswaKelas = siswaResponse.data || [];

        const absensiResponse = await callAppsScript('getAbsensi', { tanggal: tanggal });
        if (!absensiResponse.success) { throw new Error('Gagal memuat riwayat absensi.'); }
        
        console.log(`DATA MENTAH DITERIMA: ${absensiResponse.data.length} baris data absensi milik ${userData.namaLengkap}.`);

        // INILAH FILTER YANG PALING PENTING:
        // Mencari data yang cocok dengan TANGGAL, KELAS, dan JENIS ABSENSI yang dipilih saat ini.
        const existingDataForSpecificContext = absensiResponse.data.filter(item => 
            datesMatch(item.tanggal, tanggal, 'exact') && 
            item.jenisAbsen === jenisAbsen &&
            item.kelas === kelas
        );

        console.log(`DATA SETELAH FILTER SPESIFIK: Ditemukan ${existingDataForSpecificContext.length} baris yang cocok.`);

        const siswaGrid = document.getElementById('siswaGrid');
        siswaGrid.innerHTML = '';
        
        if (siswaKelas.length === 0) {
            siswaGrid.innerHTML = `<div class="col-span-full text-center py-8"><p class="text-gray-400">Belum ada data siswa untuk kelas ${kelas}.</p></div>`;
            document.getElementById('absensiContainer').classList.remove('hidden');
            return;
        }
        
        siswaKelas.forEach((siswa, index) => {
            // Cari status absensi HANYA dari data yang sudah sangat spesifik
            const existingRecord = existingDataForSpecificContext.find(item => item.nama === siswa.nama);
            const existingStatus = existingRecord ? existingRecord.status : '';

            // Jika Anda ingin melihat status yang ditemukan untuk setiap siswa, aktifkan log di bawah ini
            // console.log(`Siswa: ${siswa.nama}, Status ditemukan: '${existingStatus}'`);

            const siswaCard = document.createElement('div');
            siswaCard.className = 'neon-canvas p-4 rounded-lg hover-lift animate-fade-in';
            siswaCard.innerHTML = `
                <div class="text-center p-2">
                    <div class="w-10 sm:w-12 h-10 sm:h-12  rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="fas fa-graduation-cap text-glow text-2xl sm:text-3xl"></i>
                    </div>
                    <h4 class="text-glow font-semibold mb-3 text-sm sm:text-base break-words px-1">${siswa.nama}</h4>
                    <select class="absensi-status w-full px-2 sm:px-3 py-2 neon-input sm:text-sm" data-nama="${siswa.nama}">
                        <option value="">Pilih Status</option>
                        <option value="Hadir" ${existingStatus === 'Hadir' ? 'selected' : ''}>Hadir</option>
                        <option value="Sakit" ${existingStatus === 'Sakit' ? 'selected' : ''}>Sakit</option>
                        <option value="Izin"  ${existingStatus === 'Izin'  ? 'selected' : ''}>Izin</option>
                        <option value="Alfa"  ${existingStatus === 'Alfa'  ? 'selected' : ''}>Alfa</option>
                    </select>
                </div>
            `;
            siswaGrid.appendChild(siswaCard);

            const statusSelect = siswaCard.querySelector('.absensi-status');
            if (existingStatus) {
                statusSelect.classList.add(`status-${existingStatus.toLowerCase()}`);
            }
            statusSelect.addEventListener('change', (event) => {
                const selectedElement = event.target;
                selectedElement.classList.remove('status-hadir', 'status-sakit', 'status-izin', 'status-alfa');
                if (selectedElement.value) {
                    selectedElement.classList.add(`status-${selectedElement.value.toLowerCase()}`);
                }
            });
        });
        
        document.getElementById('absensiContainer').classList.remove('hidden');
        showNotification('Form absensi berhasil dimuat!', 'success');

    } catch (error) {
        showNotification(`Gagal memuat form absensi: ${error.message}`, 'error');
    }
}
// Function to mark all students as present
        function hadirSemua() {
            const statusElements = document.querySelectorAll('.absensi-status');
            
            statusElements.forEach(element => {
        element.value = 'Hadir';
        // Hapus semua class status lama sebelum menambahkan yang baru
        element.classList.remove('status-sakit', 'status-izin', 'status-alfa');
        // Tambahkan class status-hadir (tanpa menghapus class yang sudah ada)
        element.classList.add('status-hadir');
            });
            
            showNotification('Semua siswa telah ditandai hadir!', 'success');
        }

        async function simpanAbsensi() {
            const jenisAbsen = document.getElementById('jenisAbsen').value;
            const kelas = document.getElementById('kelasAbsen').value;
            const tanggal = document.getElementById('tanggalAbsen').value;
            const statusElements = document.querySelectorAll('.absensi-status');
            const saveButton = document.querySelector('#absensiContainer .btn-primary');
            
            setButtonLoading(saveButton, true);
            
            const absensiData = {
                jenisAbsen,
                kelas,
                tanggal,
                data: []
            };
            
            let allFilled = true;
            statusElements.forEach((element, index) => {
                const status = element.value;
                const nama = element.getAttribute('data-nama');
                
                if (!status) {
                    allFilled = false;
                    return;
                }
                
                absensiData.data.push({
                    nama: nama,
                    status: status
                });
                
                // Update visual feedback
        // INI BAGIAN YANG DIPERBAIKI DARI SEBELUMNYA
        // ======================================================
        // 1. Hapus semua class status yang mungkin ada
        element.classList.remove('status-hadir', 'status-sakit', 'status-izin', 'status-alfa');
        
        // 2. Tambahkan class status yang baru sesuai pilihan
        if (status) {
            element.classList.add(`status-${status.toLowerCase()}`);
        }
        // ======================================================
    });
    
    if (!allFilled) {
        showNotification('Mohon lengkapi status kehadiran semua siswa!', 'error');
        setButtonLoading(saveButton, false);
        return;
    }
    
    try {
        const result = await callAppsScript('saveAbsensi', absensiData);
        
        if (result.success) {
            currentAbsensiData.push(absensiData);
            showNotification('Data absensi berhasil disimpan ke Google Sheets!', 'success');
        } else {
            showNotification('Gagal menyimpan data absensi ke Google Sheets', 'error');
        }
    } catch (error) {
        showNotification('Terjadi kesalahan saat menyimpan absensi', 'error');
    }
    
    setButtonLoading(saveButton, false);
}

// --- FUNGSI MANAJEMEN MATA PELAJARAN ---
function saveMapelToStorage() {
    // Menyimpan daftar mapel ke penyimpanan lokal browser
    localStorage.setItem('mataPelajaranList', JSON.stringify(mataPelajaranList));
}

function loadMapelFromStorage() {
    // Memuat daftar mapel dari penyimpanan, atau membuat daftar default jika kosong
    const storedMapel = localStorage.getItem('mataPelajaranList');
    if (storedMapel && JSON.parse(storedMapel).length > 0) {
        mataPelajaranList = JSON.parse(storedMapel);
    } else {
        // Daftar default jika belum ada data
        mataPelajaranList = ['Informatika', 'Matematika', 'Bahasa Indonesia', 'Bahasa Inggris', 'Bahasa Palembang', 'IPA', 'IPS', 'PAI', 'PKN', 'S.Budaya', 'PJOK', 'KKA'];
        saveMapelToStorage();
    }
}

function populateAllMapelSelects() {
    // Mengisi semua dropdown mapel dengan data terbaru
    const selects = document.querySelectorAll('#agendaMapel, #jurnalMapel, #filterMapelAgenda, #filterMapelJurnal, #editAgendaMapel, #editJurnalMapel');
    selects.forEach(select => {
        if (!select) return;
        // Simpan value yang terpilih sebelumnya (jika ada)
        const selectedValue = select.value;
        select.innerHTML = '<option value="">Semua Mapel</option>'; // Opsi default
        mataPelajaranList.forEach(mapel => {
            const option = document.createElement('option');
            option.value = mapel;
            option.textContent = mapel;
            select.appendChild(option);
        });
        // Kembalikan value yang terpilih
        if (selectedValue && mataPelajaranList.includes(selectedValue)) {
            select.value = selectedValue;
        } else {
            select.value = ""; // Set ke default jika mapel sudah dihapus
        }
    });
}

function renderMapelList() {
    // Menampilkan daftar mapel di dalam modal
    const container = document.getElementById('mapelListContainer');
    container.innerHTML = '';
    if (mataPelajaranList.length === 0) {
        container.innerHTML = `<p class="text-gray-400 text-center">Belum ada mata pelajaran.</p>`;
        return;
    }
    mataPelajaranList.forEach(mapel => {
        const mapelDiv = document.createElement('div');
        mapelDiv.className = 'flex justify-between items-center bg-gray-900 p-3 rounded-lg';
        mapelDiv.innerHTML = `
            <span class="text-white">${mapel}</span>
            <button onclick="hapusMapel('${mapel}')" class="text-red-500 hover:text-red-400 text-lg">&times;</button>
        `;
        container.appendChild(mapelDiv);
    });
}

function openMapelModal() {
    renderMapelList();
    document.getElementById('mapelModal').classList.add('show');
}

function closeMapelModal() {
    document.getElementById('mapelModal').classList.remove('show');
}

function tambahMapelBaru() {
    const input = document.getElementById('newMapelInput');
    const newMapel = input.value.trim();
    if (newMapel && !mataPelajaranList.find(m => m.toLowerCase() === newMapel.toLowerCase())) {
        mataPelajaranList.push(newMapel);
        saveMapelToStorage();
        populateAllMapelSelects();
        renderMapelList();
        input.value = '';
    } else {
        showNotification('Mapel tidak boleh kosong atau sudah ada!', 'error');
    }
}

function hapusMapel(mapelToDelete) {
    mataPelajaranList = mataPelajaranList.filter(mapel => mapel !== mapelToDelete);
    saveMapelToStorage();
    populateAllMapelSelects();
    renderMapelList();
}

// Penilaian functionality
        async function loadPenilaian() {
            const kelas = document.getElementById('kelasPenilaian').value;
            const jenis = document.getElementById('jenisPenilaian').value;
            const keterangan = document.getElementById('keteranganPenilaian').value;
            
            if (!keterangan) {
                showNotification('Mohon isi keterangan penilaian!', 'error');
                return;
            }
            
            try {
                // Load fresh student data from Google Sheets
                const siswaResponse = await callAppsScript('getSiswa');
                if (siswaResponse.success && siswaResponse.data) {
                    currentSiswaData = siswaResponse.data;
                    console.log('Loaded fresh student data for penilaian:', currentSiswaData);
                }
            } catch (error) {
                console.error('Error loading student data for penilaian:', error);
            }
            
            const penilaianTable = document.getElementById('penilaianTable');
            penilaianTable.innerHTML = '';
            
            // Get students for selected class with improved filtering
            console.log('Looking for students in class:', kelas);
            const siswaKelas = currentSiswaData.filter(siswa => {
                const siswaKelas = String(siswa.kelas || '').trim();
                const targetKelas = String(kelas).trim();
                console.log(`Penilaian - Comparing: "${siswaKelas}" === "${targetKelas}"`);
                return siswaKelas === targetKelas;
            });
            
            console.log('Found students for penilaian:', siswaKelas);
            
            if (siswaKelas.length === 0) {
                penilaianTable.innerHTML = `
                    <tr>
                        <td colspan="3" class="py-8 text-center text-gray-400">
                            <i class="fas fa-users text-4xl mb-4"></i><br>
                            Belum ada data siswa untuk kelas ${kelas}<br>
                            <span class="text-sm">Silakan tambah data siswa terlebih dahulu di menu Data Siswa</span><br>
                            <span class="text-xs text-gray-500 mt-2">Total siswa di sistem: ${currentSiswaData.length}</span>
                        </td>
                    </tr>
                `;
                document.getElementById('penilaianContainer').classList.remove('hidden');
                return;
            }
            
            siswaKelas.forEach((siswa, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-700 animate-fade-in';
                row.innerHTML = `
                    <td class="py-4 pr-6 text-glow text-sm sm:text-base">${index + 1}</td>
                    <td class="py-4 pr-6 text-white text-sm sm:text-base break-words">${siswa.nama}</td>
                    <td class="py-4">
                        <input type="number" min="0" max="100" class="nilai-input w-full max-w-24 px-3 py-2 neon-input border border-gray-600 rounded-lg text-white focus:ring-2 focus:ring-purple-500 text-sm" data-siswa="${index}" data-nama="${siswa.nama}" placeholder="0-100">
                    </td>
                `;
                penilaianTable.appendChild(row);
            });
            
            document.getElementById('penilaianContainer').classList.remove('hidden');
            showNotification(`Data siswa berhasil dimuat! Ditemukan ${siswaKelas.length} siswa di kelas ${kelas}`, 'success');
        }

        async function simpanPenilaian() {
            const kelas = document.getElementById('kelasPenilaian').value;
            const jenis = document.getElementById('jenisPenilaian').value;
            const keterangan = document.getElementById('keteranganPenilaian').value;
            const nilaiElements = document.querySelectorAll('.nilai-input');
            const saveButton = document.querySelector('#penilaianContainer button');
            
            setButtonLoading(saveButton, true);
            
            const penilaianData = {
                kelas,
                jenis,
                keterangan,
                tanggal: new Date().toISOString().split('T')[0],
                data: []
            };
            
            let allFilled = true;
            nilaiElements.forEach((element, index) => {
                const nilai = parseInt(element.value);
                const nama = element.getAttribute('data-nama');
                
                if (isNaN(nilai) || nilai < 0 || nilai > 100) {
                    allFilled = false;
                    return;
                }
                
                penilaianData.data.push({
                    nama: nama,
                    nilai: nilai
                });
            });
            
            if (!allFilled) {
                showNotification('Mohon isi nilai yang valid (0-100) untuk semua siswa!', 'error');
                setButtonLoading(saveButton, false);
                return;
            }
            
            try {
                const result = await callAppsScript('savePenilaian', penilaianData);
                
                if (result.success) {
                    currentPenilaianData.push(penilaianData);
                    showNotification('Data penilaian berhasil disimpan ke Google Sheets!', 'success');
                } else {
                    showNotification('Gagal menyimpan data penilaian ke Google Sheets', 'error');
                }
            } catch (error) {
                showNotification('Terjadi kesalahan saat menyimpan penilaian', 'error');
            }
            
            setButtonLoading(saveButton, false);
        }

        // Rekapan functionality
        function showRekapTab(tab) {
            // Update tab buttons
            document.getElementById('tabAbsensi').className = tab === 'absensi' ? 
                'px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold' : 
                'px-6 py-3 neon-input text-glow rounded-lg font-semibold';
            
            document.getElementById('tabKehadiran').className = tab === 'kehadiran' ? 
                'px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold' : 
                'px-6 py-3 neon-input text-glow rounded-lg font-semibold';
            
            // Show/hide tab content
            document.getElementById('rekapAbsensiTab').classList.toggle('hidden', tab !== 'absensi');
            document.getElementById('rekapKehadiranTab').classList.toggle('hidden', tab !== 'kehadiran');
            
            // Hide rekap container
            document.getElementById('rekapContainer').classList.add('hidden');
        }

// GANTI FUNGSI LAMA ANDA DENGAN YANG BARU INI
async function loadRekapAbsensi() {
    const kelas = document.getElementById('kelasRekapAbsensi').value;
    const jenisAbsensi = document.getElementById('jenisAbsensiRekap').value;
    const periode = document.getElementById('periodeRekap').value;
    const tanggal = document.getElementById('tanggalRekapAbsensi').value;
    
    if (!tanggal) {
        showNotification('Mohon pilih tanggal!', 'error');
        return;
    }
    
    try {
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData) {
            showNotification('Data user tidak ditemukan, silakan login ulang.', 'error');
            return;
        }

        const allAbsensiResponse = await callAppsScript('getAbsensi', { tanggal: tanggal });
        let rekapData = { success: false, data: [] };
        
        if (allAbsensiResponse.success && allAbsensiResponse.data) {
            const filteredData = allAbsensiResponse.data.filter(record => {
                
                // --- PERUBAHAN 2: Tambahkan filter berdasarkan nama guru ---
                const isGuruMatch = record.namaGuru === userData.namaLengkap;
                
                const isClassMatch = String(record.kelas || '').trim() === String(kelas).trim();
                const isJenisMatch = String(record.jenisAbsen || '').trim() === String(jenisAbsensi).trim();
                const isDateMatch = (periode === 'harian') 
                    ? datesMatch(record.tanggal, tanggal, 'exact') 
                    : datesMatch(record.tanggal, tanggal, 'month');
                return isClassMatch && isJenisMatch && isDateMatch;
            });
            rekapData = { success: true, data: filteredData };
        }
        
        const rekapContent = document.getElementById('rekapContent');
        
        if (rekapData.success && rekapData.data && rekapData.data.length > 0) {
            const summary = {
                hadir: rekapData.data.filter(item => item.status === 'Hadir').length,
                sakit: rekapData.data.filter(item => item.status === 'Sakit').length,
                izin: rekapData.data.filter(item => item.status === 'Izin').length,
                alfa: rekapData.data.filter(item => item.status === 'Alfa').length
            };
            
            rekapContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-white">Rekap Absensi Kelas ${kelas}</h3>
                    <div class="text-sm text-gray-400">
                        <i class="fas fa-calendar mr-2"></i>${new Date(tanggal).toLocaleDateString('id-ID')} | ${jenisAbsensi}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Hadir: </span>
                        <span class="text-white text-xl font-bold">${summary.hadir}</span>
                    </div>
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Sakit: </span>
                        <span class="text-white text-xl font-bold">${summary.sakit}</span>
                    </div>
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Izin: </span>
                        <span class="text-white text-xl font-bold">${summary.izin}</span>
                    </div>
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Alfa: </span>
                        <span class="text-white text-xl font-bold">${summary.alfa}</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-full">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="pb-4 pr-6 text-glow text-sm sm:text-base" style="width: 60px;">No</th>
                                <th class="pb-4 pr-6 text-glow text-sm sm:text-base" style="min-width: 200px;">Nama Siswa</th>
                                <th class="pb-4 pr-6 text-glow text-sm sm:text-base" style="width: 100px;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rekapData.data.map((item, index) => `
                                <tr class="border-b border-gray-700">
                                    <td class="py-4 pr-6 text-glow text-sm sm:text-base">${index + 1}</td>
                                    <td class="py-4 pr-6 text-white text-sm sm:text-base break-words">${item.nama}</td>
                                    <td class="py-4 pr-6">
                                        <span class="px-3 py-1 rounded-full text-white text-xs sm:text-sm status-${item.status.toLowerCase()} whitespace-nowrap">${item.status}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        } else {
            rekapContent.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-calendar-times text-6xl text-gray-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-white mb-2">Tidak Ada Data Absensi</h3>
                    <p class="text-gray-400">Tidak ada data untuk filter yang dipilih.</p>
                </div>
            `;
        }
        
        document.getElementById('rekapContainer').classList.remove('hidden');
        showNotification('Rekap absensi berhasil dimuat!', 'success');
    } catch (error) {
        console.error('Error loading attendance recap:', error);
        showNotification('Gagal memuat rekap absensi', 'error');
    }
}
        
        function getKeteranganStatus(status) {
            switch(status) {
                case 'Sakit': return 'Tidak masuk karena sakit';
                case 'Izin': return 'Tidak masuk dengan izin';
                case 'Alfa': return 'Tidak masuk tanpa keterangan';
                default: return '-';
            }
        }

// FUNGSI TOTAL KEHADIRAN
// --- PERUBAHAN 1: Ambil data user yang login ---

    async function loadTotalKehadiran() {
    const kelas = document.getElementById('kelasKehadiran').value;
    const jenisAbsensi = document.getElementById('jenisKehadiran').value;
    
    try {
        const userData = JSON.parse(localStorage.getItem('userData'));
        if (!userData) {
            showNotification('Data user tidak ditemukan, silakan login ulang.', 'error');
            return;
        }

        const allAbsensiResponse = await callAppsScript('getAbsensi', { tanggal: new Date().toISOString() });
        let allAbsensiData = { success: false, data: [] };
        
        if (allAbsensiResponse.success && allAbsensiResponse.data) {
            const filteredData = allAbsensiResponse.data.filter(record => {
                
                // --- PERUBAHAN 2: Tambahkan filter berdasarkan nama guru ---
                const isGuruMatch = record.namaGuru === userData.namaLengkap;

                const recordClass = String(record.kelas || '').trim();
                const recordJenisAbsen = String(record.jenisAbsen || '').trim();
                const targetClass = String(kelas).trim();
                const targetJenisAbsen = String(jenisAbsensi).trim();

                return isGuruMatch && recordClass === targetClass && recordJenisAbsen === targetJenisAbsen;
            });
            allAbsensiData = { success: true, data: filteredData };
        }
        
        const siswaResponse = await callAppsScript('getSiswa');
        let siswaKelas = [];
        if (siswaResponse.success && siswaResponse.data) {
            siswaKelas = siswaResponse.data.filter(siswa => {
                const siswaClass = String(siswa.kelas || '').trim();
                const targetClass = String(kelas).trim();
                return siswaClass === targetClass;
            });
        }
        
        const rekapContent = document.getElementById('rekapContent');
        
        if (allAbsensiData.success && allAbsensiData.data && allAbsensiData.data.length > 0) {
            const studentStats = {};
            
            siswaKelas.forEach(siswa => {
                studentStats[siswa.nama] = { hadir: 0, sakit: 0, izin: 0, alfa: 0 };
            });
            
            allAbsensiData.data.forEach(record => {
                if (studentStats[record.nama]) {
                    const status = record.status.toLowerCase();
                    if (studentStats[record.nama][status] !== undefined) {
                        studentStats[record.nama][status]++;
                    }
                }
            });
            
            const overallTotals = { hadir: 0, sakit: 0, izin: 0, alfa: 0 };
            Object.values(studentStats).forEach(stats => {
                overallTotals.hadir += stats.hadir;
                overallTotals.sakit += stats.sakit;
                overallTotals.izin += stats.izin;
                overallTotals.alfa += stats.alfa;
            });
            
            rekapContent.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-semibold text-white">Total Kehadiran Kelas ${kelas}</h3>
                    <div class="text-sm text-gray-400">
                        <i class="fas fa-users mr-2"></i>${siswaKelas.length} Siswa | ${jenisAbsensi}
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Total Hadir: </span>
                        <span class="text-white text-xl font-bold">${overallTotals.hadir}</span>
                    </div>
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Total Sakit: </span>
                        <span class="text-white text-xl font-bold">${overallTotals.sakit}</span>
                    </div>
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Total Izin: </span>
                        <span class="text-white text-xl font-bold">${overallTotals.izin}</span>
                    </div>
                    <div class="neon-input p-4 rounded-lg">
                        <span class="text-glow font-bold">Total Alfa: </span>
                        <span class="text-white text-xl font-bold">${overallTotals.alfa}</span>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-full">
                        <thead>
                            <tr class="border-b border-gray-700">
                                <th class="pb-4 pr-4 text-glow text-xs sm:text-sm" style="width: 50px;">No</th>
                                <th class="pb-4 pr-4 text-glow text-xs sm:text-sm" style="min-width: 180px;">Nama Siswa</th>
                                <th class="pb-4 pr-4 text-glow text-xs sm:text-sm text-center" style="width: 60px;">Hadir</th>
                                <th class="pb-4 pr-4 text-glow text-xs sm:text-sm text-center" style="width: 60px;">Sakit</th>
                                <th class="pb-4 pr-4 text-glow text-xs sm:text-sm text-center" style="width: 60px;">Izin</th>
                                <th class="pb-4 pr-4 text-glow text-xs sm:text-sm text-center" style="width: 60px;">Alfa</th>
                                <th class="pb-4 pr-4 text-glow text-xs sm:text-sm text-center" style="width: 70px;">Total</th>
                                <th class="pb-4 text-glow text-xs sm:text-sm text-center" style="width: 90px;">Persentase</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${siswaKelas.map((siswa, index) => {
                                const stats = studentStats[siswa.nama];
                                const totalHari = stats.hadir + stats.sakit + stats.izin + stats.alfa;
                                const persentaseHadir = totalHari > 0 ? Math.round((stats.hadir / totalHari) * 100) : 0;
                                
                                return `
                                    <tr class="border-b border-gray-700">
                                        <td class="py-3 pr-4 text-glow text-xs sm:text-sm">${index + 1}</td>
                                        <td class="py-3 pr-4 text-white text-xs sm:text-sm break-words">${siswa.nama}</td>
                                        <td class="py-3 pr-4 text-green-400 font-semibold text-xs sm:text-sm text-center">${stats.hadir}</td>
                                        <td class="py-3 pr-4 text-yellow-400 text-xs sm:text-sm text-center">${stats.sakit}</td>
                                        <td class="py-3 pr-4 text-blue-400 text-xs sm:text-sm text-center">${stats.izin}</td>
                                        <td class="py-3 pr-4 text-red-400 text-xs sm:text-sm text-center">${stats.alfa}</td>
                                        <td class="py-3 pr-4 text-white font-semibold text-xs sm:text-sm text-center">${totalHari}</td>
                                        <td class="py-3 text-center">
                                            <span class="px-2 py-1 rounded text-xs font-semibold whitespace-nowrap ${
                                                persentaseHadir >= 90 ? 'bg-green-600 text-white' :
                                                persentaseHadir >= 75 ? 'bg-yellow-600 text-white' :
                                                'bg-red-600 text-white'
                                            }">${persentaseHadir}%</span>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6 p-4 neon-input rounded-lg">
                    <h4 class="text-white font-semibold mb-2">Keterangan Persentase Kehadiran:</h4>
                    <div class="flex flex-wrap gap-4 text-sm">
                        <div class="flex items-center">
                            <span class="w-4 h-4 bg-green-600 rounded mr-2"></span>
                            <span class="text-glow">≥90% - Sangat Baik</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-4 h-4 bg-yellow-600 rounded mr-2"></span>
                            <span class="text-glow">75-89% - Baik</span>
                        </div>
                        <div class="flex items-center">
                            <span class="w-4 h-4 bg-red-600 rounded mr-2"></span>
                            <span class="text-glow">&lt;75% - Perlu Perhatian</span>
                        </div>
                    </div>
                </div>
            `;
        } else {
            rekapContent.innerHTML = `
                <div class="text-center py-12">
                    <i class="fas fa-chart-line text-6xl text-gray-500 mb-4"></i>
                    <h3 class="text-xl font-semibold text-white mb-2">Belum Ada Data Kehadiran</h3>
                    <p class="text-gray-400">Belum ada data absensi untuk kelas ${kelas} dengan jenis ${jenisAbsensi}</p>
                </div>
            `;
        }
        
        document.getElementById('rekapContainer').classList.remove('hidden');
        showNotification(`Total kehadiran berhasil dimuat! Kelas ${kelas} - ${jenisAbsensi}`, 'success');
    } catch (error) {
        console.error('Error loading total attendance:', error);
        showNotification('Gagal memuat total kehadiran dari database', 'error');
    }
}

        async function testDatabaseConnection() {
            try {
                showNotification('Testing database connection...', 'success');
                
                // Test basic connection first
                const testResponse = await callAppsScript('test');
                console.log('Basic connection test:', testResponse);
                
                // Test getting all attendance data with correct action
                const allAbsensiResponse = await callAppsScript('getAbsensi');
                console.log('Database test result:', allAbsensiResponse);
                
                const rekapContent = document.getElementById('rekapContent');
                
                if (allAbsensiResponse.success && allAbsensiResponse.data) {
                    const data = allAbsensiResponse.data;
                    const totalRecords = data.length;
                    
                    // Group data by different criteria
                    const byClass = {};
                    const byDate = {};
                    const byJenis = {};
                    
                    data.forEach(record => {
                        // By class
                        if (!byClass[record.kelas]) byClass[record.kelas] = 0;
                        byClass[record.kelas]++;
                        
                        // By date
                        const normalizedDate = normalizeDate(record.tanggal);
                        if (!byDate[normalizedDate]) byDate[normalizedDate] = 0;
                        byDate[normalizedDate]++;
                        
                        // By jenis
                        if (!byJenis[record.jenisAbsen]) byJenis[record.jenisAbsen] = 0;
                        byJenis[record.jenisAbsen]++;
                    });
                    
                    rekapContent.innerHTML = `
                        <div class="text-center mb-6">
                            <h3 class="text-xl font-semibold text-white mb-2">Database Connection Test</h3>
                            <div class="text-green-400 text-lg">✅ Connection Successful!</div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-blue-600 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-white">${totalRecords}</div>
                                <div class="text-blue-100">Total Records</div>
                            </div>
                            <div class="bg-purple-600 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-white">${Object.keys(byClass).length}</div>
                                <div class="text-purple-100">Classes</div>
                            </div>
                            <div class="bg-green-600 p-4 rounded-lg text-center">
                                <div class="text-2xl font-bold text-white">${Object.keys(byDate).length}</div>
                                <div class="text-green-100">Unique Dates</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div class="neon-input p-4 rounded-lg">
                                <h4 class="text-white font-semibold mb-3">Records by Class</h4>
                                <div class="text-sm text-glow">
                                    ${Object.entries(byClass).map(([kelas, count]) => 
                                        `<div>Kelas ${kelas}: ${count} records</div>`
                                    ).join('')}
                                </div>
                            </div>
                            
                            <div class="neon-input p-4 rounded-lg">
                                <h4 class="text-white font-semibold mb-3">Records by Date</h4>
                                <div class="text-sm text-glow max-h-32 overflow-y-auto">
                                    ${Object.entries(byDate).sort().slice(0, 10).map(([date, count]) => 
                                        `<div>${date}: ${count} records</div>`
                                    ).join('')}
                                    ${Object.keys(byDate).length > 10 ? '<div class="text-gray-500">... and more</div>' : ''}
                                </div>
                            </div>
                            
                            <div class="neon-input p-4 rounded-lg">
                                <h4 class="text-white font-semibold mb-3">Records by Type</h4>
                                <div class="text-sm text-glow">
                                    ${Object.entries(byJenis).map(([jenis, count]) => 
                                        `<div>${jenis}: ${count} records</div>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-6 neon-input p-4 rounded-lg">
                            <h4 class="text-white font-semibold mb-2">Sample Records (First 5)</h4>
                            <pre class="text-xs text-glow bg-gray-800 p-3 rounded overflow-x-auto">${JSON.stringify(data.slice(0, 5), null, 2)}</pre>
                        </div>
                    `;
                    
                    showNotification(`Database test successful! Found ${totalRecords} attendance records`, 'success');
                } else {
                    // Test other endpoints to see what's available
                    const agendaTest = await callAppsScript('getAgenda');
                    const jurnalTest = await callAppsScript('getJurnal');
                    const siswaTest = await callAppsScript('getSiswa');
                    
                    rekapContent.innerHTML = `
                        <div class="text-center py-12">
                            <div class="text-yellow-400 text-lg mb-4">⚠️ No Attendance Data Found</div>
                            <h3 class="text-xl font-semibold text-white mb-2">Database Connection Test</h3>
                            <p class="text-gray-400 mb-4">Connected to database but no attendance data found</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                <div class="neon-input p-4 rounded-lg">
                                    <h4 class="text-white font-semibold mb-2">Attendance Data Test</h4>
                                    <div class="text-sm text-glow">
                                        <div>Success: ${allAbsensiResponse.success}</div>
                                        <div>Error: ${allAbsensiResponse.error || 'None'}</div>
                                        <div>Data Length: ${allAbsensiResponse.data ? allAbsensiResponse.data.length : 'N/A'}</div>
                                    </div>
                                </div>
                                
                                <div class="neon-input p-4 rounded-lg">
                                    <h4 class="text-white font-semibold mb-2">Other Data Tests</h4>
                                    <div class="text-sm text-glow">
                                        <div>Agenda: ${agendaTest.success ? '✅' : '❌'} (${agendaTest.data ? agendaTest.data.length : 0} records)</div>
                                        <div>Jurnal: ${jurnalTest.success ? '✅' : '❌'} (${jurnalTest.data ? jurnalTest.data.length : 0} records)</div>
                                        <div>Siswa: ${siswaTest.success ? '✅' : '❌'} (${siswaTest.data ? siswaTest.data.length : 0} records)</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="neon-input p-4 rounded-lg mt-4">
                                <h4 class="text-white font-semibold mb-2">Raw Response & Date Analysis</h4>
                                <pre class="text-xs text-glow bg-gray-800 p-3 rounded overflow-x-auto">${JSON.stringify(allAbsensiResponse, null, 2)}</pre>
                                
                                ${allAbsensiResponse.data && allAbsensiResponse.data.length > 0 ? `
                                <div class="mt-4">
                                    <h5 class="text-white font-semibold mb-2">Date Format Analysis:</h5>
                                    <div class="text-xs text-glow">
                                        ${allAbsensiResponse.data.slice(0, 5).map(record => `
                                            <div class="mb-1">
                                                <strong>Original:</strong> "${record.tanggal}" → 
                                                <strong>Normalized:</strong> "${normalizeDate(record.tanggal)}"
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="mt-4 text-sm text-gray-400">
                                <p>Kemungkinan penyebab:</p>
                                <ul class="text-left mt-2">
                                    <li>• Belum ada data absensi yang disimpan</li>
                                    <li>• Action 'getAbsensi' belum diimplementasi di Google Apps Script</li>
                                    <li>• Format data tidak sesuai</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    showNotification('Database connected but no attendance data found', 'error');
                }
                
                document.getElementById('rekapContainer').classList.remove('hidden');
            } catch (error) {
                console.error('Database test error:', error);
                showNotification('Database connection failed: ' + error.message, 'error');
                
                const rekapContent = document.getElementById('rekapContent');
                rekapContent.innerHTML = `
                    <div class="text-center py-12">
                        <div class="text-red-400 text-lg mb-4">❌ Connection Failed</div>
                        <h3 class="text-xl font-semibold text-white mb-2">Database Connection Test</h3>
                        <p class="text-gray-400 mb-4">Failed to connect to database</p>
                        <div class="neon-input p-4 rounded-lg inline-block">
                            <div class="text-red-300">Error: ${error.message}</div>
                        </div>
                    </div>
                `;
                document.getElementById('rekapContainer').classList.remove('hidden');
            }
        }

// FUNGSI CETAK REKAP
function cetakRekap() {
    const rekapContainer = document.getElementById('rekapContainer');
    const rekapContent = rekapContainer.querySelector('#rekapContent');

    if (!rekapContent || rekapContent.children.length === 0 || rekapContainer.classList.contains('hidden')) {
        showNotification('Tidak ada data rekap untuk dicetak!', 'error');
        return;
    }

    // --- Menentukan Judul Laporan Secara Dinamis ---
    let title = "Laporan Rekapan Absensi";
    let kelas, jenisAbsensi, periode, tanggal;

    const isRekapAbsensiVisible = !document.getElementById('rekapAbsensiTab').classList.contains('hidden');
    
    if (isRekapAbsensiVisible) {
        kelas = document.getElementById('kelasRekapAbsensi').value;
        jenisAbsensi = document.getElementById('jenisAbsensiRekap').value;
        periode = document.getElementById('periodeRekap').value;
        tanggal = document.getElementById('tanggalRekapAbsensi').value;
        title = `Laporan Rekap Absensi ${periode === 'harian' ? 'Harian' : 'Bulanan'}`;
    } else {
        kelas = document.getElementById('kelasKehadiran').value;
        jenisAbsensi = document.getElementById('jenisKehadiran').value;
        title = "Laporan Total Kehadiran Siswa";
    }
    // ---------------------------------------------

    const printWindow = window.open('', '_blank');
    let content = `
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                h1, h2 { text-align: center; }
                p { margin: 4px 0; }
                .kop-surat { display: flex; align-items: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; }
                .kop-surat .logo { width: 80px; height: 80px; object-fit: contain; }
                .kop-surat .teks-kop { text-align: center; flex-grow: 1; padding: 0 15px; }
                .kop-surat .teks-kop h3, .kop-surat .teks-kop p { margin: 0; line-height: 1.4; }
                
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; word-wrap: break-word; }
                th { background-color: #f2f2f2; }
                
                .signature-container { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
                .signature-block { width: 40%; text-align: center; }
                .signature-block .name { font-weight: bold; text-decoration: underline; }

                /* Gaya khusus untuk status absensi di print */
                .status-hadir { background-color: #d1fae5 !important; color: #065f46 !important; -webkit-print-color-adjust: exact; }
                .status-sakit { background-color: #fef3c7 !important; color: #92400e !important; -webkit-print-color-adjust: exact; }
                .status-izin  { background-color: #dbeafe !important; color: #1e40af !important; -webkit-print-color-adjust: exact; }
                .status-alfa  { background-color: #fee2e2 !important; color: #991b1b !important; -webkit-print-color-adjust: exact; }
                
                /* Sembunyikan elemen yang tidak perlu dicetak */
                .grid, .flex { display: block; } /* Sederhanakan layout untuk cetak */
                .neon-input, .bg-green-600, .bg-yellow-600, .bg-blue-600, .bg-red-600 { background: none !important; -webkit-print-color-adjust: exact; }
                h3, h4, .text-white { color: black !important; }
                .text-glow, .text-cyan-300 { color: #333 !important; }
            </style>
        </head>
        <body>
            <div class="kop-surat">
                <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/Logo_Palembang.png" alt="Logo Kiri" class="logo">
                <div class="teks-kop">
                    <h3>PEMERINTAH KOTA PALEMBANG</h3>
                    <h3>DINAS PENDIDIKAN</h3>
                    <h3 style="font-size: 1.2em; font-weight: bold;">SMP NEGERI 58 PALEMBANG</h3>
                    <p style="font-size: 0.9em;">Jl. Komering II, Kel. Demang Lebar Daun, Kec. Ilir Barat I, Kota Palembang 30137</p>
                    <p style="font-size: 0.9em;">Email: palembangsmpn58@gmail.com</p>
                </div>
                <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/logo58.png" alt="Logo Kanan" class="logo">
            </div>

            <h1>${title}</h1>
            <p><strong>Kelas:</strong> ${kelas}</p>
            <p><strong>Jenis Laporan:</strong> ${jenisAbsensi}</p>
            ${tanggal ? `<p><strong>Periode:</strong> ${new Date(tanggal).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>` : ''}
            <p><strong>Tanggal Cetak:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
            
            ${rekapContent.innerHTML}
    `;

    const tanggalCetak = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
    content += `
    <div class="signature-container">
        <div class="signature-block">
            <p>Mengetahui,</p>
            <p>Kepala SMPN 58 Palembang</p>
            <br><br><br><br><br>
            <p class="name">Maya Erniwaty Manalu, S.Pd.</p>
            <p>NIP. 196803151992032011</p>
        </div>
        <div class="signature-block">
            <p>Palembang, ${tanggalCetak}</p>
            <p>Guru Mata Pelajaran</p>
            <br><br><br><br><br>
            <p class="name">Aris Bermansyah, S.Kom</p>
            <p>NIPPPK. 199611142024211010</p>
        </div>
    </div>
    `;

    content += `</body></html>`;
    
    printWindow.document.write(content);
    printWindow.document.close();
    setTimeout(function () { // Memberi jeda 500ms agar gambar sempat dimuat sebelum dialog cetak muncul
    printWindow.focus();
    printWindow.print();
    }, 500);
}

// --- FUNGSI UNTUK MENU MGMP ---
function showMgmpTab(tabName) {
    // Mengatur tampilan tombol tab
    document.getElementById('tabMgmpAgenda').className = 'px-6 py-3 rounded-t-lg font-semibold ' + (tabName === 'agenda' ? 'bg-purple-600 text-white' : 'neon-input text-glow');
    document.getElementById('tabMgmpNotulen').className = 'px-6 py-3 rounded-t-lg font-semibold ' + (tabName === 'notulen' ? 'bg-purple-600 text-white' : 'neon-input text-glow');

    // Menampilkan konten tab yang dipilih
    document.getElementById('mgmpAgendaTab').classList.toggle('hidden', tabName !== 'agenda');
    document.getElementById('mgmpNotulenTab').classList.toggle('hidden', tabName !== 'notulen');
}

// FUNGSI MGMP LIST
function displayMgmpAgendaList() {
    const listContainer = document.getElementById('mgmpAgendaList');
    listContainer.innerHTML = '';

    const limitedData = currentMgmpAgendaData.slice(0, 10);

    if (limitedData.length === 0) {
        listContainer.innerHTML = `<p class="text-gray-400 text-center py-4">Belum ada agenda MGMP.</p>`;
        return;
    }

    limitedData.forEach(item => {
        const card = document.createElement('div');
        // Gunakan padding yang sudah kita perbaiki sebelumnya
        card.className = 'neon-canvas py-4 px-3 animate-fade-in';
        card.innerHTML = `
            <div class="flex flex-col">
                <div class="flex justify-between items-start mb-3">
                    <h4 class="flex-1 text-lg font-semibold text-glow break-words">${item.materi}</h4>
                </div>

                <div class="flex justify-between items-end pt-3 border-t border-gray-700 space-x-2">
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm text-cyan-300">
                        <div><i class="fas fa-tag mr-2"></i>${item.hari}</div>
                        <div><i class="fas fa-calendar mr-2"></i>${formatTanggal(item.tanggal)}</div>
                        <div><i class="fas fa-clock mr-2"></i>${formatWaktu(item.waktu)}</div>
                        <div><i class="fas fa-map-marker-alt mr-2"></i>${item.tempat}</div>
                    </div>
                    <div class="flex items-center space-x-2">
                        <button data-timestamp="${item.Timestamp}" class="edit-mgmp-btn icon-button btn-secondary p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-pencil-alt text-xs"></i>
                            <span class="tooltip-text">Edit</span>
                        </button>
                        <button data-timestamp="${item.Timestamp}" class="delete-mgmp-btn icon-button btn-danger p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-trash-alt text-xs"></i>
                            <span class="tooltip-text">Hapus</span>
                        </button>
                    </div>
                </div>
                ${item.dokumentasi ? `<div class="text-sm text-gray-400 mt-3 border-t border-gray-700 pt-2"><i class="fas fa-link mr-2"></i><a href="${item.dokumentasi}" target="_blank" class="hover:text-glow break-all">${item.dokumentasi}</a></div>` : ''}
            </div>
        `;
        listContainer.appendChild(card);
    });
}
// EFENT LISTENER AGENDA MGMP CLICK
// TAMBAHKAN BLOK EVENT LISTENER BARU INI UNTUK AGENDA MGMP
document.getElementById('mgmpAgendaList').addEventListener('click', function (event) {
    // Cek tombol EDIT
    const editButton = event.target.closest('.edit-mgmp-btn');
    if (editButton) {
        const timestamp = editButton.dataset.timestamp;
        openMgmpAgendaEditModal(timestamp);
    }

    // Cek tombol HAPUS
    const deleteButton = event.target.closest('.delete-mgmp-btn');
    if (deleteButton) {
        const timestamp = deleteButton.dataset.timestamp;
        deleteMgmpAgendaItem(timestamp);
    }
});


// FUNGSI NOTULEN LIST
function displayNotulenList() {
    const listContainer = document.getElementById('notulenList');
    listContainer.innerHTML = '';

    const limitedData = currentMgmpNotulenData.slice(0, 10);

    if (limitedData.length === 0) {
        listContainer.innerHTML = `<p class="text-gray-400 text-center py-4">Belum ada notulen yang tersimpan.</p>`;
        return;
    }

    limitedData.forEach(item => {
        const card = document.createElement('div');
        card.className = 'neon-canvas p-4 animate-fade-in';
        card.innerHTML = `
            <div class="flex justify-between items-start mb-2">
                <h4 class="flex-1 text-lg font-semibold text-glow break-words">Notulen Rapat Ke-${item.ke}: ${item.agenda}</h4>
                <span class="text-sm text-gray-400 whitespace-nowrap ml-4">${formatTanggal(item.tanggal)}</span>
            </div>
            <p class="text-sm text-cyan-300 mb-4">Pimpinan: ${item.pimpinan}</p>
            
            <div class="space-y-3 border-t border-gray-700 pt-3">
                <p class="text-sm text-white"><strong class="text-glow">Refleksi:</strong> ${item.refleksi}</p>
                <p class="text-sm text-white"><strong class="text-glow">Tindak Lanjut:</strong> ${item.tindakLanjut}</p>
            </div>

            <div class="flex justify-end items-center space-x-2 mt-4 pt-4 border-t border-gray-700">
                <button data-timestamp="${item.Timestamp}" class="edit-notulen-btn icon-button btn-secondary p-2 h-9 w-9 flex items-center justify-center">
                    <i class="fas fa-pencil-alt text-xs"></i>
                    <span class="tooltip-text">Edit</span>
                </button>
                <button data-timestamp="${item.Timestamp}" class="delete-notulen-btn icon-button btn-danger p-2 h-9 w-9 flex items-center justify-center">
                    <i class="fas fa-trash-alt text-xs"></i>
                    <span class="tooltip-text">Hapus</span>
                </button>
            </div>
        `;
        listContainer.appendChild(card);
    });
}

// FUNGSI DISPLAY PENILAIAN LIST
function displayPenilaianList() {
    const daftarPenilaian = document.getElementById('daftarPenilaian');
    if (!daftarPenilaian) return;

    const groupedData = groupPenilaianData(currentPenilaianData);
    daftarPenilaian.innerHTML = '';

    if (groupedData.length === 0) {
        daftarPenilaian.innerHTML = `<p class="text-gray-400 text-center py-4">Anda belum menginput data penilaian.</p>`;
        return;
    }

    const limitedData = groupedData.slice(0, 10);

    limitedData.forEach((item, index) => {
        const card = document.createElement('div');
        card.className = 'neon-canvas py-4 px-3 animate-fade-in';
        
        // =============================================
        // ==     PERUBAHAN TATA LETAK KARTU DIMULAI    ==
        // =============================================
        card.innerHTML = `
            <div class="flex flex-col">

                <div class="flex justify-between items-start mb-3 space-x-4">
                    <h4 class="flex-1 text-lg font-semibold text-glow break-words">${item.keterangan}</h4>
                    <span class="flex-shrink-0 px-3 py-1 bg-purple-600 text-white text-sm rounded-full">${item.jenis}</span>
                </div>

                <div class="flex justify-between items-end pt-3 border-t border-gray-700 space-x-2">
                    
                    <div class="flex-1 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm text-cyan-300">
                        <div><i class="fas fa-calendar mr-2"></i>${formatTanggal(item.tanggal)}</div>
                        <div><i class="fas fa-users mr-2"></i>Kelas ${item.kelas}</div>
                        <div class="sm:col-span-2"><i class="fas fa-user-graduate mr-2"></i>${item.detailNilai.length} siswa dinilai</div>
                    </div>

                    <div class="flex items-center space-x-2">
                        <button onclick="showPenilaianDetail(${index})" class="icon-button btn-secondary p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-eye text-xs"></i>
                            <span class="tooltip-text">Lihat Detail</span>
                        </button>
                        <button onclick="openPenilaianEditModal('${item.Timestamp}')" class="icon-button btn-secondary p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-pencil-alt text-xs"></i>
                            <span class="tooltip-text">Edit</span>
                        </button>
                        <button onclick="deletePenilaianItem('${item.Timestamp}')" class="icon-button btn-danger p-2 h-9 w-9 flex items-center justify-center">
                            <i class="fas fa-trash-alt text-xs"></i>
                            <span class="tooltip-text">Hapus</span>
                        </button>
                    </div>
                </div>

            </div>
        `;
        // =============================================
        
        daftarPenilaian.appendChild(card);
    });
}

//DUA FUNGSI SHOW PENILAIAN DETAIL
function showPenilaianDetail(index) {
    // Ambil kembali data yang sudah dikelompokkan
    const groupedData = groupPenilaianData(currentPenilaianData);
    const selectedData = groupedData[index];

    if (!selectedData) {
        showNotification('Data tidak ditemukan!', 'error');
        return;
    }

    // Ambil elemen-elemen modal dari HTML
    const modal = document.getElementById('penilaianDetailModal');
    const titleEl = document.getElementById('modalDetailTitle');
    const tableBodyEl = document.getElementById('modalDetailTableBody');

    // Atur judul modal
    titleEl.textContent = `Detail Nilai: ${selectedData.keterangan} (${selectedData.kelas})`;

    // Kosongkan isi tabel sebelumnya
    tableBodyEl.innerHTML = '';

    // Isi tabel dengan data nama dan nilai siswa
    selectedData.detailNilai.forEach((siswa, i) => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-700';
        row.innerHTML = `
            <td class="py-3 pr-4 text-glow">${i + 1}</td>
            <td class="py-3 pr-4 text-white break-words">${siswa.nama}</td>
            <td class="py-3 text-white font-semibold text-center">${siswa.nilai}</td>
        `;
        tableBodyEl.appendChild(row);
    });

    // Tampilkan modal
    modal.classList.remove('hidden');
}

function closePenilaianDetailModal() {
    document.getElementById('penilaianDetailModal').classList.add('hidden');
}

// Event Listener untuk Form Agenda MGMP
document.getElementById('mgmpAgendaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = {
        hari: document.getElementById('mgmpHari').value,
        tanggal: document.getElementById('mgmpTanggal').value,
        waktu: document.getElementById('mgmpWaktu').value,
        tempat: document.getElementById('mgmpTempat').value,
        materi: document.getElementById('mgmpMateri').value,
        dokumentasi: document.getElementById('mgmpDokumentasi').value,
    };

    if (!data.tanggal || !data.waktu || !data.materi) {
        showNotification('Tanggal, Waktu, dan Materi wajib diisi!', 'error');
        return;
    }
    
    const result = await callAppsScript('addMgmpAgenda', data);
    
    if (result.success) {
        // --- PERBAIKAN DI SINI ---
        // Jangan lagi menggunakan 'unshift'. Ambil data baru dari server.
        const response = await callAppsScript('getMgmpAgenda');
        if (response.success) {
            currentMgmpAgendaData = response.data;
            displayMgmpAgendaList();
        }
        
        this.reset();
        showNotification('Agenda MGMP berhasil disimpan!', 'success');
    } else {
        showNotification('Gagal menyimpan agenda MGMP!', 'error');
    }
});

// Event Listener untuk Form Notulen
document.getElementById('notulenForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const data = {
        ke: document.getElementById('notulenKe').value,
        hari: document.getElementById('notulenHari').value,
        tanggal: document.getElementById('notulenTanggal').value,
        waktu: document.getElementById('notulenWaktu').value,
        tempat: document.getElementById('notulenTempat').value,
        agenda: document.getElementById('notulenAgenda').value,
        pimpinan: document.getElementById('notulenPimpinan').value,
        peserta: document.getElementById('notulenPeserta').value,
        hadir: document.getElementById('notulenHadir').value,
        tidakHadir: document.getElementById('notulenTidakHadir').value,
        keterangan: document.getElementById('notulenKeterangan').value,
        refleksi: document.getElementById('notulenRefleksi').value,
        tindakLanjut: document.getElementById('notulenTindakLanjut').value,
    };

    if (!data.ke || !data.tanggal || !data.agenda) {
        showNotification('Rapat Ke, Tanggal, dan Agenda wajib diisi!', 'error');
        return;
    }

    // Ganti 'addNotulen' dengan nama sheet Anda jika perlu
    const result = await callAppsScript('addNotulen', data);
    if (result.success) {
        // Ambil kembali data dari server untuk sinkronisasi
        const response = await callAppsScript('getNotulen');
        if (response.success) {
            currentMgmpNotulenData = response.data;
            displayNotulenList();
        }
        this.reset();
        showNotification('Notulen berhasil disimpan!', 'success');
    }
});
        // --- FUNGSI PRINT ---
// GANTI KESELURUHAN FUNGSI printData LAMA ANDA DENGAN INI

function printData(dataType) {
    let dataToPrint;
    let title;
    let filterMapel = '';

    // Langkah 1: Tentukan data dan judul berdasarkan tipe (Kode Anda, sudah benar)
    if (dataType === 'agenda') {
        filterMapel = document.getElementById('filterMapelAgenda').value;
        dataToPrint = filterMapel 
            ? currentAgendaData.filter(item => item.mapel === filterMapel)
            : currentAgendaData;
        title = "Laporan Agenda Guru";
    } else if (dataType === 'jurnal') {
        filterMapel = document.getElementById('filterMapelJurnal').value;
        dataToPrint = filterMapel
            ? currentJurnalData.filter(item => item.mapel === filterMapel)
            : currentJurnalData;
        title = "Laporan Jurnal Guru";
    } else if (dataType === 'mgmpAgenda') {
        dataToPrint = currentMgmpAgendaData;
        title = "Laporan Agenda MGMP";
    } else if (dataType === 'notulen') {
        dataToPrint = currentMgmpNotulenData;
        title = "Laporan Notulen Rapat MGMP";
    }

    if (!dataToPrint || dataToPrint.length === 0) {
        showNotification('Tidak ada data untuk dicetak!', 'error');
        return;
    }

    // =======================================================
    // ==           PERBAIKAN DIMULAI DARI SINI             ==
    // =======================================================

    // PERBAIKAN 1: Balik urutan data agar menjadi kronologis (terlama di atas)
    const dataToPrintChronological = [...dataToPrint].reverse();

    // PERBAIKAN 2: Ambil data user yang login dari localStorage
    const userData = JSON.parse(localStorage.getItem('userData')) || { namaLengkap: 'Nama Guru', nip: '-' };

    // =======================================================

    const printWindow = window.open('', '_blank');
    let content = `
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                h1, h2 { text-align: center; }
                p { margin: 4px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .signature-container { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
                .signature-block { width: 40%; text-align: center; }
                .signature-block .name { font-weight: bold; text-decoration: underline; }
                .kop-surat { display: flex; align-items: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; }
                .kop-surat .logo { width: 80px; height: 80px; object-fit: contain; }
                .kop-surat .teks-kop { text-align: center; flex-grow: 1; padding: 0 15px; }
                .kop-surat .teks-kop h3, .kop-surat .teks-kop p { margin: 0; line-height: 1.4; }
            </style>
        </head>
        <body>
            <div class="kop-surat">
                <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/Logo_Palembang.png" alt="Logo Kiri" class="logo">
                <div class="teks-kop">
                    <h3>PEMERINTAH KOTA PALEMBANG</h3>
                    <h3>DINAS PENDIDIKAN</h3>
                    <h3 style="font-size: 1.2em; font-weight: bold;">SMP NEGERI 58 PALEMBANG</h3>
                    <p style="font-size: 0.9em;">Jl. Komering II, Kel. Demang Lebar Daun, Kec. Ilir Barat I, Kota Palembang 30137</p>
                    <p style="font-size: 0.9em;">Email: palembangsmpn58@gmail.com</p>
                </div>
                <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/logo58.png" alt="Logo Kanan" class="logo">
            </div>

            <h1>${title}</h1>
    `;

    if (dataType === 'agenda' || dataType === 'jurnal') {
        content += `<p><strong>Mata Pelajaran:</strong> ${filterMapel || 'Semua'}</p>`;
    }

    content += `
            <p><strong>Tanggal Cetak:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
            <table>
    `;

    // Langkah 3: Buat isi tabel berdasarkan tipe data
    if (dataType === 'agenda') {
        content += `
            <thead><tr><th>Tanggal</th><th>Waktu</th><th>Kelas</th><th>Materi/Kegiatan</th><th>Jenis</th></tr></thead>
            <tbody>
                ${dataToPrintChronological.map(item => `
                    <tr>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${formatWaktu(item.waktu)}</td>
                        <td>${item.kelas}</td>
                        <td>${item.materi}</td>
                        <td>${item.jenis}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
    } else if (dataType === 'jurnal') {
        content += `
            <thead><tr><th>Tanggal</th><th>Jam Ke</th><th>Kelas</th><th>Materi</th><th>Hadir</th><th>Tidak Hadir</th></tr></thead>
            <tbody>
                ${dataToPrintChronological.map(item => `
                    <tr>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.jam}</td>
                        <td>${item.kelas}</td>
                        <td>${item.materi}</td>
                        <td>${item.hadir}</td>
                        <td>${item.tidakHadir}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
    } else if (dataType === 'mgmpAgenda') {
        content += `
            <thead><tr><th>Hari</th><th>Tanggal</th><th>Waktu</th><th>Tempat</th><th>Materi/Bahasan</th></tr></thead>
            <tbody>
                ${dataToPrintChronological.map(item => `
                    <tr>
                        <td>${item.hari}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${formatWaktu(item.waktu)}</td>
                        <td>${item.tempat}</td>
                        <td>${item.materi}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
    } else if (dataType === 'notulen') {
        content += `
            <thead><tr><th>Rapat Ke</th><th>Tanggal</th><th>Agenda</th><th>Pimpinan</th><th>Hasil Refleksi</th><th>Tindak Lanjut</th></tr></thead>
            <tbody>
                ${dataToPrintChronological.map(item => `
                    <tr>
                        <td>${item.ke}</td>
                        <td>${formatTanggal(item.tanggal)}</td>
                        <td>${item.agenda}</td>
                        <td>${item.pimpinan}</td>
                        <td>${item.refleksi}</td>
                        <td>${item.tindakLanjut}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
    }

    content += `</table>`;

    const tanggalCetak = new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

    content += `
        <div class="signature-container">
            <div class="signature-block">
                <p>Mengetahui,</p>
                <p>Kepala SMPN 58 Palembang</p>
                <br><br><br><br>
                <p class="name">Maya Erniwaty Manalu, S.Pd.</p>
                <p>NIP. 196803151992032011</p>
            </div>
            <div class="signature-block">
                <p>Palembang, ${tanggalCetak}</p>
                <p>Guru Mata Pelajaran</p>
                <br><br><br><br>
                <p class="name">${userData.namaLengkap}</p>
                <p>${userData.nip ? `${userData.nip}` : ''}</p>
            </div>
        </div>
    `;

    content += `</body></html>`;
    
    printWindow.document.write(content);
    printWindow.document.close();
    setTimeout(function () {
        printWindow.focus();
        printWindow.print();
    }, 500);
}

//TAMBAHKAN FUNGSI CETAK BARU UNTUK PRINT PENILAIAN
function printPenilaian() {
    if (!currentPenilaianData || currentPenilaianData.length === 0) {
        showNotification('Tidak ada data penilaian untuk dicetak!', 'error');
        return;
    }

    const dataToPrint = [...currentPenilaianData].reverse();
    const userData = JSON.parse(localStorage.getItem('userData')) || { namaLengkap: 'Nama Guru', nip: '-' };
    const title = "Laporan Penilaian Siswa";

    const printWindow = window.open('', '_blank');
    let content = `
        <html>
        <head>
            <title>${title}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
                h1, h2 { text-align: center; }
                p { margin: 4px 0; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                .signature-container { margin-top: 50px; display: flex; justify-content: space-between; page-break-inside: avoid; }
                .signature-block { width: 40%; text-align: center; }
                .signature-block .name { font-weight: bold; text-decoration: underline; }
                .kop-surat { display: flex; align-items: center; border-bottom: 3px solid black; padding-bottom: 10px; margin-bottom: 20px; }
                .kop-surat .logo { width: 80px; height: 80px; object-fit: contain; }
                .kop-surat .teks-kop { text-align: center; flex-grow: 1; padding: 0 15px; }
                .kop-surat .teks-kop h3, .kop-surat .teks-kop p { margin: 0; line-height: 1.4; }
            </style>
        </head>
        <body>
            <div class="kop-surat">
                <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/Logo_Palembang.png" alt="Logo Kiri" class="logo">
                <div class="teks-kop">
                    <h3>PEMERINTAH KOTA PALEMBANG</h3>
                    <h3>DINAS PENDIDIKAN</h3>
                    <h3 style="font-size: 1.2em; font-weight: bold;">SMP NEGERI 58 PALEMBANG</h3>
                    <p style="font-size: 0.9em;">Jl. Komering II, Kel. Demang Lebar Daun, Kec. Ilir Barat I, Kota Palembang 30137</p>
                    <p style="font-size: 0.9em;">Email: palembangsmpn58@gmail.com</p>
                </div>
                <img src="https://raw.githubusercontent.com/xiroro-ab/smp58dataguru/refs/heads/main/logo58.png" alt="Logo Kanan" class="logo">
            </div>

            <h1>${title}</h1>
            <p><strong>Guru:</strong> ${userData.namaLengkap}</p>
            <p><strong>Tanggal Cetak:</strong> ${new Date().toLocaleDateString('id-ID')}</p>
            
            <table>
                <thead>
                    <tr>
                        <th style="width: 40px;">No</th>
                        <th>Tanggal</th>
                        <th>Kelas</th>
                        <th>Jenis Penilaian</th>
                        <th>Keterangan</th>
                        <th>Nama Siswa</th>
                        <th style="width: 80px;">Nilai</th>
                    </tr>
                </thead>
                <tbody>
                    ${dataToPrint.map((item, index) => `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${formatTanggal(item.tanggal)}</td>
                            <td>${item.kelas}</td>
                            <td>${item.jenis}</td>
                            <td>${item.keterangan}</td>
                            <td>${item.nama}</td>
                            <td>${item.nilai}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>

            <div class="signature-container">
                <div class="signature-block">
                    <p>Mengetahui,</p>
                    <p>Kepala SMPN 58 Palembang</p>
                    <br><br><br><br><br>
                    <p class="name">Maya Erniwaty Manalu, S.Pd.</p>
                    <p>NIP. 196803151992032011</p>
                </div>
                <div class="signature-block">
                    <p>Palembang, ${new Date().toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })}</p>
                    <p>Guru Mata Pelajaran</p>
                    <br><br><br><br><br>
                    <p class="name">${userData.namaLengkap}</p>
                    <p>${userData.nip ? `${userData.nip}` : ''}</p>
                </div>
            </div>
        </body>
        </html>
    `;
    
    printWindow.document.write(content);
    printWindow.document.close();
    setTimeout(() => { printWindow.print(); }, 500);
}

//PASANG EVENT LISTENER INI (cukup sekali)
document.getElementById('cetakPenilaianBtn').addEventListener('click', printPenilaian);


// FUNGSI GROUPING PENILAIAN
function groupPenilaianData(data) {
    const grouped = {};

    data.forEach(item => {
        const key = `${item.tanggal}-${item.kelas}-${item.jenis}-${item.keterangan}`;

        if (!grouped[key]) {
            grouped[key] = {
                // --- PERBAIKAN DI SINI: Tambahkan Timestamp ---
                Timestamp: item.Timestamp, // Ambil timestamp dari item pertama grup ini
                tanggal: item.tanggal,
                kelas: item.kelas,
                jenis: item.jenis,
                keterangan: item.keterangan,
                detailNilai: []
            };
        }
        
        grouped[key].detailNilai.push({
            nama: item.nama,
            nilai: item.nilai
        });
    });

    return Object.values(grouped);
}

        // Initialize app
// GANTI BLOK LAMA DENGAN VERSI FINAL INI
document.addEventListener('DOMContentLoaded', function() {
    console.log("DOM Content Loaded: Memulai pengaturan awal...");

    try {
        // =======================================================
        // ==                 PERBAIKAN DI SINI                 ==
        // =======================================================
        // Ambil komponen tanggal LOKAL, bukan UTC
        const localDate = new Date();
        const year = localDate.getFullYear();
        const month = String(localDate.getMonth() + 1).padStart(2, '0'); // +1 karena bulan dimulai dari 0
        const day = String(localDate.getDate()).padStart(2, '0');
        const today = `${year}-${month}-${day}`;
        // =======================================================

        console.log("Tanggal hari ini (LOKAL):", today); // Log ini akan menunjukkan tanggal 5

        const dateInputs = [
            'agendaTanggal', 'jurnalTanggal', 'tanggalAbsen', 
            'tanggalRekapAbsensi', 'mgmpTanggal', 'notulenTanggal'
        ];

        dateInputs.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.value = today;
            }
        });

        // Kode inisialisasi lain
        loadMapelFromStorage();
        populateAllMapelSelects();
        document.getElementById('sidebarClose').addEventListener('click', closeSidebar);
        console.log("Pengaturan awal selesai.");

    } catch (error) {
        console.error("💥 ERROR di dalam DOMContentLoaded:", error);
    }
});

        // Responsive sidebar handling - simplified
        window.addEventListener('resize', function() {
            // Sidebar behavior is now consistent across all devices
            // Always starts hidden and can be toggled with hamburger button
        });

// Listener tombol hapus dan edit
document.getElementById('siswaTableBody').addEventListener('click', function(event) {
    
    // Cek apakah tombol EDIT yang diklik
    const editButton = event.target.closest('.edit-btn');
    if (editButton) {
        const timestamp = editButton.dataset.timestamp;
        openSiswaEditModal(timestamp); // Panggil fungsi edit
        return; // Hentikan eksekusi agar tidak lanjut ke pengecekan hapus
    }

    // Cek apakah tombol HAPUS yang diklik (kode yang sudah ada)
    const deleteButton = event.target.closest('.hapus-btn');
    if (deleteButton) {
        const nama = deleteButton.dataset.nama;
        const kelas = deleteButton.dataset.kelas;
        hapusSiswa(nama, kelas); // Panggil fungsi hapus
    }
});

// Fungsi untuk membuka modal dan mengisinya dengan data lama
// GANTI FUNGSI LAMA DENGAN VERSI BARU INI
function openAgendaEditModal(timestamp) {
    // 1. Cari data agenda yang cocok di dalam array 'currentAgendaData'
    const agendaItem = currentAgendaData.find(item => item.Timestamp === timestamp);
    
    // 2. Jika data tidak ditemukan, tampilkan error dan hentikan fungsi
    if (!agendaItem) {
        showNotification('Data agenda tidak ditemukan!', 'error');
        return;
    }

    // 3. Isi semua field di form MODAL EDIT dengan data yang ditemukan
    // Menggunakan fungsi formatTanggal & formatWaktu agar formatnya benar
    document.getElementById('editAgendaTimestamp').value = agendaItem.Timestamp;
    document.getElementById('editAgendaTanggal').value = formatTanggal(agendaItem.tanggal); // Menggunakan formatTanggal
    document.getElementById('editAgendaWaktu').value = formatWaktu(agendaItem.waktu);     // Menggunakan formatWaktu
    document.getElementById('editAgendaMapel').value = agendaItem.mapel;
    document.getElementById('editAgendaKelas').value = agendaItem.kelas;
    document.getElementById('editAgendaMateri').value = agendaItem.materi;
    document.getElementById('editAgendaJenis').value = agendaItem.jenis;
    
    // 4. Tampilkan Modal Edit
    document.getElementById('editAgendaModal').classList.remove('hidden');
}
// BUAT FUNGSI BARU INI UNTUK MENUTUP MODAL
function closeEditAgendaModal() {
    document.getElementById('editAgendaModal').classList.add('hidden');
}
// Event Listener untuk Form Edit agenda (Baru)
document.getElementById('editAgendaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);

    const timestamp = document.getElementById('editAgendaTimestamp').value;
    const updatedData = {
        tanggal: document.getElementById('editAgendaTanggal').value,
        waktu: document.getElementById('editAgendaWaktu').value,
        mapel: document.getElementById('editAgendaMapel').value,
        kelas: document.getElementById('editAgendaKelas').value,
        materi: document.getElementById('editAgendaMateri').value,
        jenis: document.getElementById('editAgendaJenis').value
    };

    const result = await callAppsScript('updateRow', {
        sheetName: 'Agenda_Guru',
        timestamp: timestamp,
        newRecord: updatedData
    });

    if (result.success) {
        closeEditAgendaModal(); // Tutup modal
        // Muat ulang data dari server
        const response = await callAppsScript('getAgenda');
        if (response.success) {
            currentAgendaData = response.data;
            displayAgendaList();
        }
        showNotification('Agenda berhasil diperbarui!', 'success');
    }

    setButtonLoading(submitButton, false);
});
// Fungsi untuk menghapus item agenda
async function deleteAgendaItem(timestamp) {
    if (await showConfirmationModal('Apakah Anda yakin ingin menghapus agenda ini?')) {
        const result = await callAppsScript('deleteRow', {
            sheetName: 'Agenda_Guru', // Nama sheet yang benar
            timestamp: timestamp
        });

        if (result.success) {
            // Muat ulang data dari server untuk memastikan konsistensi
            const response = await callAppsScript('getAgenda');
            if (response.success) {
                currentAgendaData = response.data;
                displayAgendaList();
            }
            showNotification('Agenda berhasil dihapus.', 'success');
        }
    }
}


//fungsi untuk membuka tutup edit jurnal
function openJurnalEditModal(timestamp) {
    // 1. Cari data jurnal yang cocok di dalam array 'currentJurnalData'
    const jurnalItem = currentJurnalData.find(item => item.Timestamp === timestamp);
    
    // 2. Jika tidak ditemukan, tampilkan error
    if (!jurnalItem) {
        showNotification('Data jurnal tidak ditemukan!', 'error');
        return;
    }

    // 3. Isi semua field di form MODAL EDIT dengan data yang ditemukan
    document.getElementById('editJurnalTimestamp').value = jurnalItem.Timestamp;
    document.getElementById('editJurnalTanggal').value = formatTanggal(jurnalItem.tanggal);
    document.getElementById('editJurnalJam').value = jurnalItem.jam;
    document.getElementById('editJurnalMapel').value = jurnalItem.mapel;
    document.getElementById('editJurnalKelas').value = jurnalItem.kelas;
    document.getElementById('editJurnalHadir').value = jurnalItem.hadir;
    document.getElementById('editJurnalTidakHadir').value = jurnalItem.tidakHadir;
    document.getElementById('editJurnalMateri').value = jurnalItem.materi;
    document.getElementById('editJurnalCatatan').value = jurnalItem.catatan || ''; // Beri fallback jika catatan kosong
    
    // 4. Tampilkan Modal Edit Jurnal
    document.getElementById('editJurnalModal').classList.remove('hidden');
}

function closeEditJurnalModal() {
    document.getElementById('editJurnalModal').classList.add('hidden');
}
// Event Listener untuk Form Edit jurnal (Baru)
document.getElementById('editJurnalForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);

    const timestamp = document.getElementById('editJurnalTimestamp').value;
    const updatedData = {
        tanggal: document.getElementById('editJurnalTanggal').value,
        jam: document.getElementById('editJurnalJam').value,
        mapel: document.getElementById('editJurnalMapel').value,
        kelas: document.getElementById('editJurnalKelas').value,
        materi: document.getElementById('editJurnalMateri').value,
        hadir: document.getElementById('editJurnalHadir').value,
        tidakHadir: document.getElementById('editJurnalTidakHadir').value,
        catatan: document.getElementById('editJurnalCatatan').value
    };

    const result = await callAppsScript('updateRow', {
        sheetName: 'Jurnal_Guru',
        timestamp: timestamp,
        newRecord: updatedData
    });

    if (result.success) {
        closeEditJurnalModal();
        const response = await callAppsScript('getJurnal');
        if (response.success) {
            currentJurnalData = response.data;
            displayJurnalList();
        }
        showNotification('Jurnal berhasil diperbarui!', 'success');
    }

    setButtonLoading(submitButton, false);
});

//fungsi untuk menghapus item jurnal
async function deleteJurnalItem(timestamp) {
    if (await showConfirmationModal('Apakah Anda yakin ingin menghapus jurnal ini?')) {
        const result = await callAppsScript('deleteRow', {
            sheetName: 'Jurnal_Guru', // Nama sheet yang benar
            timestamp: timestamp
        });

        if (result.success) {
            const response = await callAppsScript('getJurnal');
            if (response.success) {
                currentJurnalData = response.data;
                displayJurnalList();
            }
            showNotification('Jurnal berhasil dihapus.', 'success');
        }
    }
}

//fungsi untuk membuka tutup edit siswa
function openSiswaEditModal(timestamp) {
    const siswaItem = currentSiswaData.find(item => item.Timestamp === timestamp);
    if (!siswaItem) {
        showNotification('Data siswa tidak ditemukan!', 'error');
        return;
    }

    // Isi field di modal edit
    document.getElementById('editSiswaTimestamp').value = siswaItem.Timestamp;
    document.getElementById('editSiswaNama').value = siswaItem.nama;
    document.getElementById('editSiswaKelas').value = siswaItem.kelas;
    
    // Tampilkan Modal Edit
    document.getElementById('editSiswaModal').classList.remove('hidden');
}

function closeSiswaEditModal() {
    document.getElementById('editSiswaModal').classList.add('hidden');
}
// Event Listener untuk Form Edit Siswa
// TAMBAHKAN FUNGSI BARU INI MENANGANI SUBMIT SISWA
async function handleSiswaSubmit(event) {
    event.preventDefault();
    
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);
    
    const siswaData = {
        nama: document.getElementById('namaSiswa').value.trim(),
        kelas: document.getElementById('kelasSiswa').value
    };
    
    if (!siswaData.nama) {
        showNotification('Mohon isi nama siswa!', 'error');
        setButtonLoading(submitButton, false);
        return;
    }
    
    // Kirim data ke server untuk ditambahkan
    const result = await callAppsScript('addSiswa', siswaData);

    if (result.success) {
        // Ambil kembali SEMUA data siswa dari server untuk memastikan data sinkron dan dapat Timestamp
        const response = await callAppsScript('getSiswa');
        if (response.success) {
            currentSiswaData = response.data; // Perbarui array global
            
            // Tampilkan ulang daftar, dan langsung filter ke kelas yang baru ditambahkan
            document.getElementById('filterKelas').value = siswaData.kelas;
            displaySiswaList(siswaData.kelas); 
        }

        this.reset();
        showNotification('Data siswa berhasil ditambahkan!', 'success');
    }
    
    setButtonLoading(submitButton, false);
}
// LETAKKAN INI DI BAGIAN BAWAH SCRIPT BERSAMA LISTENER LAINNYA
document.getElementById('siswaForm').addEventListener('submit', handleSiswaSubmit);

// SUMBIT EDIT SISWA.
document.getElementById('editSiswaForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);

    try { // Kita gunakan 'try' untuk menangkap potensi error
        const timestamp = document.getElementById('editSiswaTimestamp').value;
        const newRecord = {
            nama: document.getElementById('editSiswaNama').value,
            kelas: document.getElementById('editSiswaKelas').value,
        };

        const result = await callAppsScript('updateRow', {
            sheetName: 'Data_Siswa',
            timestamp: timestamp,
            newRecord: newRecord
        });

        if (result.success) {
            closeSiswaEditModal();
            // Panggil kembali fungsi loadDataSiswa yang sudah kita perbaiki
            // untuk me-refresh tampilan dengan benar.
            await loadDataSiswa(); 
            showNotification('Data siswa berhasil diperbarui!', 'success');
        }
        // Pesan error jika gagal sudah ditangani oleh callAppsScript

    } catch (error) {
        console.error("Error saat submit edit siswa:", error);
        // showNotification tidak perlu di sini karena sudah ada di callAppsScript
    } finally {
        // 'finally' memastikan baris ini akan SELALU berjalan, baik prosesnya sukses maupun gagal.
        // Ini mencegah tombol 'macet' dalam keadaan loading.
        setButtonLoading(submitButton, false);
    }
});


// FUNGSI UNTUK BUKA TUTUP PENILAIAN
function openPenilaianEditModal(timestamp) {
    // Cari grup data berdasarkan timestamp item pertamanya
    const groupedData = groupPenilaianData(currentPenilaianData);
    const groupItem = groupedData.find(group => group.Timestamp === timestamp);

    if (!groupItem) {
        showNotification('Grup data penilaian tidak ditemukan!', 'error');
        return;
    }

    // Isi field info utama yang readonly
    document.getElementById('editPenilaianKeterangan').value = groupItem.keterangan;
    document.getElementById('editPenilaianKelas').value = groupItem.kelas;
    
    // =============================================
    // ==     LOGIKA BARU UNTUK MENAMPILKAN NILAI     ==
    // =============================================
    const siswaListContainer = document.getElementById('editPenilaianSiswaList');
    siswaListContainer.innerHTML = ''; // Kosongkan daftar sebelumnya

    const table = document.createElement('table');
    table.className = 'w-full text-left';
    let tableContent = `<tbody>`;
    
    // Loop melalui siswa di dalam grup yang ditemukan
    groupItem.detailNilai.forEach(siswa => {
        // Cari data asli siswa ini di `currentPenilaianData` untuk mendapatkan Timestamp-nya
        const originalItem = currentPenilaianData.find(item => 
            item.nama === siswa.nama && 
            item.keterangan === groupItem.keterangan &&
            item.kelas === groupItem.kelas &&
            item.tanggal === groupItem.tanggal
        );
        const itemTimestamp = originalItem ? originalItem.Timestamp : '';

        tableContent += `
            <tr class="border-b border-gray-700">
                <td class="py-2 pr-4 text-white">${siswa.nama}</td>
                <td style="width: 120px;">
                    <input type="number" value="${siswa.nilai}" 
                           data-timestamp="${itemTimestamp}"
                           class="edit-nilai-input w-full neon-input text-center">
                </td>
            </tr>
        `;
    });

    tableContent += `</tbody>`;
    table.innerHTML = tableContent;
    siswaListContainer.appendChild(table);
    // =============================================

    // Tampilkan Modal Edit
    document.getElementById('editPenilaianModal').classList.remove('hidden');
}

function closeEditPenilaianModal() {
    document.getElementById('editPenilaianModal').classList.add('hidden');
}
// Fungsi untuk Menghapus Item Penilaian
async function deletePenilaianItem(timestamp) {
    if (await showConfirmationModal('Data nilai siswa yang terkait juga akan terhapus. Yakin?')) {
        const result = await callAppsScript('deleteRow', {
            sheetName: 'Penilaian', // Nama sheet yang benar
            timestamp: timestamp
        });

        if (result.success) {
            // Muat ulang data dari server
            const response = await callAppsScript('getPenilaian');
            if (response.success) {
                currentPenilaianData = response.data;
                displayPenilaianList();
            }
            showNotification('Kegiatan penilaian berhasil dihapus.', 'success');
        }
    }
}
// Event Listener untuk Form Edit Penilaian
document.getElementById('editPenilaianForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);

    try {
        const updatePromises = [];
        const nilaiInputs = document.querySelectorAll('#editPenilaianSiswaList .edit-nilai-input');

        // Kumpulkan semua perintah update yang perlu dijalankan
        nilaiInputs.forEach(input => {
            const timestamp = input.dataset.timestamp;
            const newNilai = parseInt(input.value) || 0;

            if (timestamp) {
                const promise = callAppsScript('updateRow', {
                    sheetName: 'Penilaian',
                    timestamp: timestamp,
                    newRecord: {
                        nilai: newNilai
                    }
                });
                updatePromises.push(promise);
            }
        });

        // Jalankan semua perintah update secara bersamaan
        const results = await Promise.all(updatePromises);
        
        // Cek jika ada yang gagal
        const isError = results.some(res => !res.success);

        if (!isError) {
            closeEditPenilaianModal();
            const response = await callAppsScript('getPenilaian');
            if (response.success) {
                currentPenilaianData = response.data;
                displayPenilaianList();
            }
            showNotification('Semua nilai berhasil diperbarui!', 'success');
        } else {
            showNotification('Beberapa nilai gagal diperbarui.', 'error');
        }

    } catch (error) {
        console.error("Error saat update nilai:", error);
    } finally {
        setButtonLoading(submitButton, false);
    }
});

// FUNGSI BUKA TUTUP EDIT DAN HAPUS mgmpagenda
function openMgmpAgendaEditModal(timestamp) {
    // PERBAIKAN: Kita bandingkan dalam format ISO string agar konsisten
    const agendaItem = currentMgmpAgendaData.find(item => 
        new Date(item.Timestamp).toISOString() === timestamp
    );

    if (!agendaItem) {
        showNotification('Data agenda MGMP tidak ditemukan!', 'error');
        return;
    }

    // Sisa fungsi ini sudah benar
    document.getElementById('editMgmpAgendaTimestamp').value = agendaItem.Timestamp;
    document.getElementById('editMgmpHari').value = agendaItem.hari;
    document.getElementById('editMgmpTanggal').value = formatTanggal(agendaItem.tanggal);
    document.getElementById('editMgmpWaktu').value = formatWaktu(agendaItem.waktu);
    document.getElementById('editMgmpTempat').value = agendaItem.tempat;
    document.getElementById('editMgmpMateri').value = agendaItem.materi;
    document.getElementById('editMgmpDokumentasi').value = agendaItem.dokumentasi || '';
    
    document.getElementById('editMgmpAgendaModal').classList.remove('hidden');
}

function closeEditMgmpAgendaModal() {
    document.getElementById('editMgmpAgendaModal').classList.add('hidden');
}
//FUNGSI UNTUK MENGHAPUSNYA
async function deleteMgmpAgendaItem(timestamp) {
    if (await showConfirmationModal('Apakah Anda yakin ingin menghapus agenda MGMP ini?')) {
        const result = await callAppsScript('deleteRow', {
            sheetName: 'MgmpAgenda', // Nama sheet yang benar
            timestamp: timestamp
        });

        if (result.success) {
            const response = await callAppsScript('getMgmpAgenda');
            if (response.success) {
                currentMgmpAgendaData = response.data;
                displayMgmpAgendaList();
            }
            showNotification('Agenda MGMP berhasil dihapus.', 'success');
        }
    }
}
// Event Listener untuk Form Edit Agenda MGMP (Baru)
document.getElementById('editMgmpAgendaForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const timestamp = document.getElementById('editMgmpAgendaTimestamp').value;
    const newRecord = {
        hari: document.getElementById('editMgmpHari').value,
        tanggal: document.getElementById('editMgmpTanggal').value,
        waktu: document.getElementById('editMgmpWaktu').value,
        tempat: document.getElementById('editMgmpTempat').value,
        materi: document.getElementById('editMgmpMateri').value,
        dokumentasi: document.getElementById('editMgmpDokumentasi').value
    };

    const result = await callAppsScript('updateRow', {
        sheetName: 'MgmpAgenda',
        timestamp: timestamp,
        newRecord: newRecord
    });

    if (result.success) {
        closeEditMgmpAgendaModal();
        const response = await callAppsScript('getMgmpAgenda');
        if (response.success) {
            currentMgmpAgendaData = response.data;
            displayMgmpAgendaList();
        }
        showNotification('Agenda MGMP berhasil diperbarui!', 'success');
    }
});

// FUNGSI UNTUK BUKA TUTUP EDIT NOTULEN
function openNotulenEditModal(timestamp) {
    const notulenItem = currentMgmpNotulenData.find(item => new Date(item.Timestamp).toISOString() === timestamp);
    if (!notulenItem) {
        showNotification('Data notulen tidak ditemukan!', 'error');
        return;
    }

    // Isi semua field di modal edit
    document.getElementById('editNotulenTimestamp').value = notulenItem.Timestamp;
    document.getElementById('editNotulenKe').value = notulenItem.ke;
    document.getElementById('editNotulenHari').value = notulenItem.hari;
    document.getElementById('editNotulenTanggal').value = formatTanggal(notulenItem.tanggal);
    document.getElementById('editNotulenWaktu').value = formatWaktu(notulenItem.waktu);
    document.getElementById('editNotulenTempat').value = notulenItem.tempat;
    document.getElementById('editNotulenAgenda').value = notulenItem.agenda;
    document.getElementById('editNotulenPimpinan').value = notulenItem.pimpinan;
    document.getElementById('editNotulenPeserta').value = notulenItem.peserta;
    document.getElementById('editNotulenHadir').value = notulenItem.hadir;
    document.getElementById('editNotulenTidakHadir').value = notulenItem.tidakHadir;
    document.getElementById('editNotulenKeterangan').value = notulenItem.keterangan;
    document.getElementById('editNotulenRefleksi').value = notulenItem.refleksi;
    document.getElementById('editNotulenTindakLanjut').value = notulenItem.tindakLanjut;
    
    document.getElementById('editNotulenModal').classList.remove('hidden');
}

function closeEditNotulenModal() {
    document.getElementById('editNotulenModal').classList.add('hidden');
}
//FUNGSI UNTUK MENGHAPUS ITEM NOTULEN
async function deleteNotulenItem(timestamp) {
    if (await showConfirmationModal('Apakah Anda yakin ingin menghapus notulen ini?')) {
        const result = await callAppsScript('deleteRow', {
            sheetName: 'Notulen', // Nama sheet yang benar
            timestamp: timestamp
        });

        if (result.success) {
            const response = await callAppsScript('getNotulen');
            if (response.success) {
                currentMgmpNotulenData = response.data;
                displayNotulenList();
            }
            showNotification('Notulen berhasil dihapus.', 'success');
        }
    }
}
// EVENT LISTENER UNTUK FIX ONCLICK
document.getElementById('notulenList').addEventListener('click', function (event) {
    const editButton = event.target.closest('.edit-notulen-btn');
    if (editButton) {
        const timestamp = editButton.dataset.timestamp;
        openNotulenEditModal(timestamp);
    }

    const deleteButton = event.target.closest('.delete-notulen-btn');
    if (deleteButton) {
        const timestamp = deleteButton.dataset.timestamp;
        deleteNotulenItem(timestamp);
    }
});
// EVENT LISTENER UNTUK FORM EDIT NOTULEN BARU
document.getElementById('editNotulenForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    const timestamp = document.getElementById('editNotulenTimestamp').value;
    const newRecord = {
        ke: document.getElementById('editNotulenKe').value,
        hari: document.getElementById('editNotulenHari').value,
        tanggal: document.getElementById('editNotulenTanggal').value,
        waktu: document.getElementById('editNotulenWaktu').value,
        tempat: document.getElementById('editNotulenTempat').value,
        agenda: document.getElementById('editNotulenAgenda').value,
        pimpinan: document.getElementById('editNotulenPimpinan').value,
        peserta: document.getElementById('editNotulenPeserta').value,
        hadir: document.getElementById('editNotulenHadir').value,
        tidakHadir: document.getElementById('editNotulenTidakHadir').value,
        keterangan: document.getElementById('editNotulenKeterangan').value,
        refleksi: document.getElementById('editNotulenRefleksi').value,
        tindakLanjut: document.getElementById('editNotulenTindakLanjut').value,
    };

    const result = await callAppsScript('updateRow', {
        sheetName: 'Notulen',
        timestamp: timestamp,
        newRecord: newRecord
    });

    if (result.success) {
        closeEditNotulenModal();
        const response = await callAppsScript('getNotulen');
        if (response.success) {
            currentMgmpNotulenData = response.data;
            displayNotulenList();
        }
        showNotification('Notulen berhasil diperbarui!', 'success');
    }
});

// Fungsi untuk navigasi
// ====================================================================
// == KODE FINAL UNTUK NAVIGASI & FITUR LUPA PASSWORD (GANTI SEMUA) ==
// ====================================================================

// Kumpulan fungsi untuk navigasi antar halaman login/daftar/lupa password
function showRegisterPage() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('forgotPasswordPage').classList.add('hidden');
    document.getElementById('forgotPasswordSuccessPage').classList.add('hidden');
    document.getElementById('registerPage').classList.remove('hidden');
}

function showLoginPage() {
    document.getElementById('registerPage').classList.add('hidden');
    document.getElementById('forgotPasswordPage').classList.add('hidden');
    document.getElementById('forgotPasswordSuccessPage').classList.add('hidden');
    document.getElementById('loginPage').classList.remove('hidden');
}

function showForgotPasswordPage() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('registerPage').classList.add('hidden');
    document.getElementById('forgotPasswordSuccessPage').classList.add('hidden');
    document.getElementById('forgotPasswordPage').classList.remove('hidden');
}

// Fungsi untuk menampilkan halaman sukses SETELAH mengambil email admin
async function showForgotPasswordSuccessPage() {
    try {
        console.log("Mencoba mengambil email admin...");
        // Ambil email admin dari backend dan TUNGGU jawabannya
        const result = await callAppsScript('getAdminEmail');
        if (result.success && result.email) {
            // Tulis email ke dalam elemen HTML
            document.getElementById('adminEmailDisplay').textContent = result.email;
            console.log("Email admin berhasil ditampilkan:", result.email);
        } else {
            console.error("Gagal mendapatkan email admin dari backend.", result);
        }
    } catch (error) {
        console.error("Error saat memanggil getAdminEmail:", error);
    }

    // Sembunyikan halaman lain dan tampilkan halaman sukses
    document.getElementById('forgotPasswordPage').classList.add('hidden');
    document.getElementById('forgotPasswordSuccessPage').classList.remove('hidden');
}

// Event listener untuk form lupa password
document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);

    const username = document.getElementById('forgotUsername').value;
    if (!username) {
        showNotification('Username wajib diisi!', 'error');
        setButtonLoading(submitButton, false);
        return;
    }

    try {
        const result = await callAppsScript('forgotPassword', { username: username });
        if (result.success) {
            // Panggil fungsi untuk menampilkan halaman sukses
            await showForgotPasswordSuccessPage(); 
            this.reset();
        }
    } finally {
        setButtonLoading(submitButton, false);
    }
});

// Event listener untuk form registrasi
document.getElementById('registerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const submitButton = this.querySelector('button[type="submit"]');
    setButtonLoading(submitButton, true);

    const registerData = {
        username: document.getElementById('regUsername').value,
        password: document.getElementById('regPassword').value,
        email: document.getElementById('regEmail').value,
        namaLengkap: document.getElementById('regNamaLengkap').value,
        nip: document.getElementById('regNip').value
    };

    if (!registerData.username || !registerData.password || !registerData.namaLengkap || !registerData.email) {
        showNotification('Username, Password, Email, dan Nama Lengkap wajib diisi!', 'error');
        setButtonLoading(submitButton, false);
        return;
    }

    try {
        const result = await callAppsScript('requestRegistration', registerData);
        if (result.success) {
            showNotification(result.message, 'success');
            showLoginPage();
            this.reset();
        }
    } finally {
        setButtonLoading(submitButton, false);
    }
});



// FUNGSI BARU UNTUK MEMPERBARUI NAMA DI HEADER
function updateUserUI() {
    const userData = JSON.parse(localStorage.getItem('userData'));
    const userNameDisplay = document.getElementById('userNameDisplay');

    if (userNameDisplay && userData) {
        userNameDisplay.textContent = userData.namaLengkap;
    } else if (userNameDisplay) {
        // Kosongkan nama jika tidak ada data user (misalnya setelah logout)
        userNameDisplay.textContent = ''; 
    }
}

//HANDLELOGINSUBMIT.
async function handleLoginSubmit(event) {
    event.preventDefault(); 
    const username = document.getElementById('username').value;
    const password = document.getElementById('password').value;
    const result = await callAppsScript('login', { username, password });
    
    if (result.success) {
        // Simpan data ke localStorage
        localStorage.setItem('userToken', result.token);
        localStorage.setItem('userData', JSON.stringify(result.user));
        
        // Panggil fungsi untuk memperbarui tampilan header
        updateUserUI(); 

        // Tampilkan aplikasi utama
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        
        // Muat semua data awal
        initializeSampleData(); 
    }
}


       // FUNGSI UNTUK NOTIFIKASI
function showConfirmationModal(message) {
    const modal = document.getElementById('confirmationModal');
    const messageEl = document.getElementById('modalMessage');
    const yesBtn = document.getElementById('confirmYesBtn');
    const noBtn = document.getElementById('confirmNoBtn');

    messageEl.textContent = message;
    modal.classList.remove('hidden');

    return new Promise((resolve) => {
        // Fungsi ini akan dipanggil saat tombol "Ya" di-klik
        const handleYes = () => {
            modal.classList.add('hidden');
            resolve(true); // Mengirim jawaban 'true'
        };

        // Fungsi ini akan dipanggil saat tombol "Batal" di-klik
        const handleNo = () => {
            modal.classList.add('hidden');
            resolve(false); // Mengirim jawaban 'false'
        };

        // Pasang listener HANYA SEKALI
        yesBtn.addEventListener('click', handleYes, { once: true });
        noBtn.addEventListener('click', handleNo, { once: true });
    });
} 
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97513c6eb147dfa8',t:'MTc1NjE4OTM2MC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
